# 影刀定时任务：移动超时任务到历史任务表

## 📋 功能说明

使用影刀每小时定时执行，将超时任务（`count_down < 0`）从 `task` 表插入到 `task_history` 表。

**重要**：只插入到 `task_history`，**不删除** `task` 表中的数据。

## 🔍 超时任务定义

**超时任务**：`count_down < 0`（倒计时为负数）的任务

- `count_down < 0` 表示任务已超过截止日期
- 未选择方案：`count_down = 1 - (当前时间 - created_at的天数差)`，当 `count_down < 0` 时超时
- 已选择方案：`count_down = 168 - (当前时间 - created_at的小时差)`，当 `count_down < 0` 时超时

## 📝 实现方式

### 方案一：SQL 脚本（简单版本）

**文件**：`sql/postgresql/move_failed_tasks_to_history.sql`

```sql
BEGIN;

-- 将超时任务插入到 task_history 表
INSERT INTO task_history (
  ware_sku,
  completed_sale_day,
  charge,
  promised_land,
  completed_at,
  inventory_num,
  sales_num,
  label
)
SELECT 
  t.ware_sku,
  t.sale_day AS completed_sale_day,
  t.charge,
  t.promised_land,
  CURRENT_TIMESTAMP AS completed_at,
  t.inventory_num,
  t.sales_num,
  t.label
FROM task t
WHERE t.count_down < 0  -- 超时任务：倒计时为负数
  AND t.ware_sku NOT IN (
    -- 避免重复插入：检查今天是否已插入过
    SELECT ware_sku 
    FROM task_history 
    WHERE completed_at >= CURRENT_DATE
      AND completed_at < CURRENT_DATE + INTERVAL '1 day'
  );

-- 注意：不删除 task 表中的数据，只做插入操作

COMMIT;
```

### 方案二：Python 代码（影刀编码版，推荐）

**文件**：`scripts/move_timeout_tasks.py`

使用 Python 连接数据库，包含完整的错误处理和日志输出。

## ⚙️ 影刀配置步骤

### 方案一：使用 SQL 脚本

#### 1. 创建数据库连接

在影刀中配置 PostgreSQL 数据库连接：
- **主机**：数据库地址
- **端口**：5432（默认）
- **数据库名**：`seas_ware`
- **用户名**：`neondb_owner`（或你的数据库用户）
- **密码**：数据库密码

#### 2. 创建定时任务

1. 在影刀中创建新的自动化流程
2. 添加"执行 SQL"步骤
3. 选择数据库连接
4. 将 SQL 脚本内容粘贴到 SQL 编辑框
5. 设置定时执行：每小时执行一次

### 方案二：使用 Python 代码（编码版，推荐）

#### 1. 安装依赖

在影刀编码版中，确保已安装 `psycopg2` 库：

```bash
pip install psycopg2-binary
```

#### 2. 配置数据库连接

修改 `scripts/move_timeout_tasks.py` 中的数据库配置：

```python
DB_CONFIG = {
    'host': 'your-db-host',      # 数据库地址
    'port': 5432,                # 端口
    'database': 'seas_ware',     # 数据库名
    'user': 'neondb_owner',      # 用户名
    'password': 'your-password', # 密码
    'sslmode': 'require'         # Neon 数据库需要 SSL
}
```

或者使用环境变量（更安全）：

```python
DB_CONFIG = {
    'host': os.getenv('DB_HOST'),
    'port': int(os.getenv('DB_PORT', '5432')),
    'database': os.getenv('DB_NAME'),
    'user': os.getenv('DB_USER'),
    'password': os.getenv('DB_PASSWORD'),
    'sslmode': 'require'
}
```

#### 3. 在影刀中创建定时任务

1. 在影刀编码版中创建新的自动化流程
2. 添加"Python 代码"步骤
3. 将 `scripts/move_timeout_tasks.py` 的代码粘贴到代码编辑框
4. 设置定时执行：每小时执行一次

### 3. 执行频率建议

- **推荐频率**：每小时执行一次
- **执行时间**：建议在每小时的第 5 分钟执行（例如：01:05, 02:05, 03:05...）
- **原因**：避免与系统其他定时任务冲突

## 🔍 字段映射说明

| task 表字段 | task_history 表字段 | 说明 |
|------------|-------------------|------|
| `ware_sku` | `ware_sku` | SKU 货号 |
| `sale_day` | `completed_sale_day` | 完成时的可售天数 |
| `charge` | `charge` | 负责人 |
| `promised_land` | `promised_land` | 方案选择 |
| `CURRENT_TIMESTAMP` | `completed_at` | 完成时间（当前时间） |
| `inventory_num` | `inventory_num` | 库存数量快照 |
| `sales_num` | `sales_num` | 最近7天销量快照 |
| `label` | `label` | 标签快照（JSONB） |

## ✅ 验证查询

执行后可以使用以下 SQL 验证结果：

```sql
-- 查看本次移动的记录数（今天插入的记录）
SELECT COUNT(*) as moved_count 
FROM task_history 
WHERE completed_at >= CURRENT_DATE 
  AND completed_at < CURRENT_DATE + INTERVAL '1 day';

-- 查看当前 task 表中超时任务数
SELECT COUNT(*) as timeout_tasks_count 
FROM task 
WHERE count_down < 0;

-- 查看超时任务的详细信息
SELECT ware_sku, count_down, charge, promised_land, created_at
FROM task 
WHERE count_down < 0
ORDER BY count_down ASC;
```

## ⚠️ 注意事项

1. **不删除数据**：脚本**只插入**到 `task_history`，**不删除** `task` 表中的数据
2. **数据一致性**：使用事务（`BEGIN`/`COMMIT`），确保数据一致性
3. **重复执行**：会检查今天是否已插入，避免重复插入
4. **错误处理**：如果执行失败，事务会自动回滚，不会影响数据
5. **性能考虑**：如果 `task` 表中超时任务数量很大，建议在非高峰期执行
6. **倒计时更新**：确保 `task` 表的 `count_down` 字段已更新（系统会在查询时自动更新）

## 📊 执行日志

影刀执行后可以查看：
- 插入到 `task_history` 的记录数
- 从 `task` 删除的记录数
- 执行是否成功

## 🔄 与系统其他功能的配合

- **导入数据时**：系统会自动检测任务完成（`sale_day >= 15` 变为 `< 15`），并移动到历史任务
- **影刀定时任务**：每小时检测超时任务（`count_down < 0`），并插入到历史任务
- **两者互补**：确保所有需要移动到历史的任务都能被正确处理

## 📊 执行日志示例

使用 Python 代码执行时，会输出详细的执行日志：

```
============================================================
影刀定时任务：移动超时任务到历史任务表
============================================================
[2026-01-07 10:05:00] 开始连接数据库...
[2026-01-07 10:05:01] 发现 5 个超时任务
[2026-01-07 10:05:02] ✅ 成功插入 5 条超时任务到 task_history
[2026-01-07 10:05:02] 注意：task 表中的数据保持不变（未删除）
[2026-01-07 10:05:02] 当前 task 表中仍有 5 个超时任务
[2026-01-07 10:05:02] 数据库连接已关闭
============================================================
```

