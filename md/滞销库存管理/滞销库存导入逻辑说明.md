# 滞销库存导入逻辑说明

## 概述

滞销库存管理页面的导入功能用于从 Excel 文件导入库存数据，并根据导入的库存数量和最近七天销量重新计算可售天数和标签。

## 核心逻辑

### 1. SKU 唯一性

- 使用 `ware_sku`（SKU货号）作为唯一标识匹配记录
- 每个 SKU 在数据库中只能有一条记录

### 2. 数据计算

导入时会根据 Excel 数据计算以下字段：

- **`inventory_num`（库存数量）**：所有仓库的库存数量相加
  - 计算公式：`库存数量 - 待发货量 + 在途量`
  - 所有仓库数据汇总

- **`sales_num`（最近七天销量）**：所有仓库的销量相加
  - 所有仓库数据汇总

- **`sale_day`（可售天数）**：根据新的库存数量和最近七天销量重新计算
  - 计算公式：`可售天数 = 库存数量 × 7 / 最近七天销量`
  - 如果最近七天销量为 0，则 `sale_day` 为 `null`

- **`label`（标签）**：根据新的 `inventory_num`、`sales_num` 和 `sale_day` 重新生成
  - 标签生成规则：
    - `inventory_num = 0` → 标签 1（无库存）
    - `sales_num = 0` → 标签 2（无销量）
    - `sales_num > 300` → 标签 3（爆款）
    - `sale_day > 15`（无爆款）或 `sale_day > 30`（有爆款）→ 标签 4（在售天数预警）
    - `inventory_num < 0` → 标签 5（库存待冲平）

### 3. 更新策略

#### 已存在的 SKU（UPDATE）

- 根据新的 `inventory_num` 和 `sales_num` 重新计算 `sale_day` 和 `label`
- `charge`（负责人）字段：
  - 如果原记录已有 `charge` 值，保持不变
  - 如果原记录没有 `charge` 值，根据匹配规则设置（从 `per_charge` 表匹配或特殊规则）

#### 不存在的 SKU（INSERT）

- 插入新记录
- 所有字段根据计算和匹配规则设置

### 4. charge 字段匹配规则

1. **特殊规则**：如果 `ware_sku` 包含 "ZMT"，直接设置为 "朱梦婷"
2. **普通匹配**：`ware_sku` 包含 `per_charge.sku` 时，使用对应的 `per_charge.charge`
3. **默认值**：如果没有匹配到，设置为 `null`

## Excel 文件要求

### 必需列

- `马帮SKU`：SKU 货号（唯一标识）
- `仓库`：仓库名称
- `库存数量`：当前库存数量
- `待发货量`：待发货数量
- `在途量`：在途数量
- `最近7天销量`：最近七天的销量

### 文件格式

- 支持 `.xlsx` 和 `.xls` 格式
- 文件大小限制：10MB
- 读取第一个工作表的数据

## 导入流程

1. **文件验证**：检查文件格式和大小
2. **解析 Excel**：读取并解析 Excel 文件数据
3. **数据分组**：按 SKU 分组，汇总所有仓库的数据
4. **计算字段**：计算 `inventory_num`、`sales_num`、`sale_day` 和 `label`
5. **匹配 charge**：根据匹配规则设置 `charge` 字段
6. **数据库操作**：
   - 已存在的 SKU：执行 UPDATE
   - 不存在的 SKU：执行 INSERT
7. **同步任务表**：导入完成后，自动同步符合条件的记录到 `task` 表
   - 同步条件：label 包含 4（在售天数预警）或 label 包含 2 但不包含 1 且不包含 5（有库存无销量）
8. **返回结果**：返回导入成功/失败信息和统计（新增数量、更新数量）

## 注意事项

1. **覆盖更新**：导入时会覆盖已存在 SKU 的 `inventory_num`、`sales_num`、`sale_day` 和 `label` 字段
2. **charge 保留**：已存在的 `charge` 值在更新时会被保留，不会被覆盖
3. **数据汇总**：所有仓库的数据会被汇总计算，不再筛选特定仓库
4. **事务处理**：导入操作在数据库事务中执行，确保数据一致性
5. **任务表同步**：导入完成后会自动同步数据到 `task` 表，也可以通过页面上的"刷新"按钮手动刷新

