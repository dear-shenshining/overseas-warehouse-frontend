# 滞销库存管理需求说明 - 任务流程优化

## 一、需求概述

本次需求主要涉及三个方面的改动：
1. **大盘标签逻辑调整**：将异常标签阈值从15天调整为20天
2. **任务流程优化**：增加"完成检查"和"审核"两个新状态
3. **任务重复处理逻辑**：优化任务重复出现时的处理机制

---

## 二、SQL字段变更

### 2.1 task表现有字段（参考）

根据 `sql/postgresql/create_task_table.sql` 和 `sql/postgresql/add_image_url_to_task.sql`，`task` 表当前包含以下字段：

- `id` (SERIAL PRIMARY KEY) - 主键ID
- `ware_sku` (VARCHAR(255) UNIQUE) - 马帮SKU（唯一标识）
- `inventory_num` (INTEGER) - 库存数量
- `sales_num` (INTEGER) - 最近7天销量
- `sale_day` (INTEGER) - 销售天数
- `charge` (VARCHAR(255)) - 费用/负责人
- `label` (JSONB) - 标签列表
- `promised_land` (INTEGER) - 方案选择：0=未选择，1=退回厂家，2=降价清仓，3=打处理
- `count_down` (INTEGER) - 倒计时数字（小时）
- `image_urls` (JSONB) - 任务相关图片URL数组
- `created_at` (TIMESTAMP) - 创建时间
- `updated_at` (TIMESTAMP) - 更新时间

### 2.2 task表新增字段

需要在 `task` 表中新增以下字段：

```sql
-- 任务状态字段
-- 0=未选择方案（原有逻辑，与promised_land=0对应）
-- 1=退回厂家（原有逻辑，与promised_land=1对应）
-- 2=降价清仓（原有逻辑，与promised_land=2对应）
-- 3=打处理（原有逻辑，与promised_land=3对应）
-- 4=完成检查（新增）
-- 5=审核中（新增）
task_status INTEGER DEFAULT 0 NOT NULL

-- 审核状态字段（仅在审核中状态时使用）
-- NULL=未审核
-- 'rejected'=已打回
-- 'approved'=已通过
review_status VARCHAR(20) DEFAULT NULL

-- 打回理由字段（仅在打回时使用）
reject_reason TEXT DEFAULT NULL

-- 方案快照字段（从任务正在进行中转入完成检查时保存）
-- 保存转入完成检查时的promised_land值，后续不再允许修改
promised_land_snapshot INTEGER DEFAULT NULL

-- 转入完成检查的时间
checked_at TIMESTAMP DEFAULT NULL

-- 转入审核的时间
reviewed_at TIMESTAMP DEFAULT NULL
```

**SQL迁移脚本：**

完整的 SQL 迁移脚本已保存在 `sql/postgresql/add_task_status_fields.sql`，可以直接执行。

```sql
-- 添加新字段
ALTER TABLE task 
ADD COLUMN IF NOT EXISTS task_status INTEGER DEFAULT 0 NOT NULL,
ADD COLUMN IF NOT EXISTS review_status VARCHAR(20) DEFAULT NULL,
ADD COLUMN IF NOT EXISTS reject_reason TEXT DEFAULT NULL,
ADD COLUMN IF NOT EXISTS promised_land_snapshot INTEGER DEFAULT NULL,
ADD COLUMN IF NOT EXISTS checked_at TIMESTAMP DEFAULT NULL,
ADD COLUMN IF NOT EXISTS reviewed_at TIMESTAMP DEFAULT NULL;

-- 初始化现有数据的 task_status（根据 promised_land 设置）
UPDATE task SET task_status = promised_land WHERE task_status = 0 AND promised_land IN (1, 2, 3);

-- 添加注释
COMMENT ON COLUMN task.task_status IS '任务状态：0=未选择方案，1=退回厂家，2=降价清仓，3=打处理，4=完成检查，5=审核中';
COMMENT ON COLUMN task.review_status IS '审核状态：NULL=未审核，rejected=已打回，approved=已通过';
COMMENT ON COLUMN task.reject_reason IS '打回理由';
COMMENT ON COLUMN task.promised_land_snapshot IS '方案快照（转入完成检查时的promised_land值）';
COMMENT ON COLUMN task.checked_at IS '转入完成检查的时间';
COMMENT ON COLUMN task.reviewed_at IS '转入审核的时间';
```

### 2.3 task_history表现有字段（参考）

根据 `sql/postgresql/create_task_history_table.sql`，`task_history` 表当前包含以下字段：

- `id` (SERIAL PRIMARY KEY) - 主键ID
- `ware_sku` (VARCHAR(255)) - 马帮SKU（可以有重复）
- `completed_sale_day` (INTEGER) - 完成时的可售天数
- `charge` (VARCHAR(255)) - 完成时的负责人
- `promised_land` (INTEGER) - 完成时选择的方案
- `completed_at` (TIMESTAMP) - 完成时间
- `inventory_num` (INTEGER) - 完成时的库存数量快照
- `sales_num` (INTEGER) - 完成时的最近7天销量快照
- `label` (JSONB) - 完成时的标签快照

### 2.4 task_history表新增字段

需要在 `task_history` 表中新增字段用于记录审核信息：

```sql
-- 审核状态（记录完成时的审核状态）
review_status VARCHAR(20) DEFAULT NULL

-- 打回理由（如果被审核打回过）
reject_reason TEXT DEFAULT NULL

-- 任务状态快照（记录完成时的任务状态）
task_status_snapshot INTEGER DEFAULT NULL
```

**SQL迁移脚本：**

完整的 SQL 迁移脚本已保存在 `sql/postgresql/add_task_status_fields.sql`，可以直接执行。

```sql
ALTER TABLE task_history 
ADD COLUMN IF NOT EXISTS review_status VARCHAR(20) DEFAULT NULL,
ADD COLUMN IF NOT EXISTS reject_reason TEXT DEFAULT NULL,
ADD COLUMN IF NOT EXISTS task_status_snapshot INTEGER DEFAULT NULL;

-- 添加注释
COMMENT ON COLUMN task_history.review_status IS '审核状态快照：NULL=未审核，rejected=已打回，approved=已通过，timeout=超时';
COMMENT ON COLUMN task_history.reject_reason IS '打回理由快照';
COMMENT ON COLUMN task_history.task_status_snapshot IS '任务状态快照（完成时的task_status值）';
```

---

## 三、数据流转逻辑

### 3.1 任务状态流转图

```
未选择方案 (promised_land=0, task_status=0)
    ↓ [选择方案]
任务正在进行中 (promised_land=1/2/3, task_status=1/2/3)
    ↓ [点击确认完成]
完成检查 (task_status=4, promised_land_snapshot=原promised_land值)
    ↓ [点击确认]
审核中 (task_status=5)
    ↓ [管理员审核]
    ├─ 打回 → 完成检查 (task_status=4, review_status='rejected')
    └─ 已完成 → 历史任务 (task_history表)
```

### 3.2 状态说明

1. **未选择方案** (`task_status=0`, `promised_land=0`)
   - 条件：`promised_land=0 AND task_status=0`
   - 行为：用户可以选择方案（1/2/3），选择后 `task_status` 和 `promised_land` 同步更新

2. **任务正在进行中** (`task_status=1/2/3`, `promised_land=1/2/3`)
   - 条件：`promised_land IN (1,2,3) AND task_status IN (1,2,3)`
   - 行为：
     - 可以修改方案（修改时 `task_status` 和 `promised_land` 同步更新）
     - 可以上传图片（`image_urls` 字段）
     - 可以点击"确认完成"按钮，转入完成检查状态

3. **完成检查** (`task_status=4`)
   - 条件：`task_status=4`
   - 行为：
     - `promised_land` 字段显示为固定值（从 `promised_land_snapshot` 读取，不再使用 `promised_land`）
     - 方案字段不可修改（只读显示）
     - 有"确认"按钮，点击后进入审核状态
     - 转入时记录：`promised_land_snapshot = 原promised_land值`，`checked_at = 当前时间`

4. **审核中** (`task_status=5`)
   - 条件：`task_status=5`
   - 行为：
     - 仅管理员可见
     - 方案字段显示为固定值（从 `promised_land_snapshot` 读取）
     - 有"确定"按钮，点击后弹出对话框，可以选择"打回"或"已完成"
     - 打回需要填写打回理由（必填）
     - 转入时记录：`reviewed_at = 当前时间`

### 3.3 超时处理逻辑

**触发条件：** `count_down < 0`（倒计时为负数）

**处理逻辑：**
1. 自动将 `promised_land` 重置为 `0`（未选择方案）
2. 将 `task_status` 重置为 `0`
3. 清除 `promised_land_snapshot`、`checked_at`、`reviewed_at`、`review_status`、`reject_reason` 等字段
4. 在 `task_history` 表中创建一条记录：
   - `completed_at` = 当前时间
   - `task_status_snapshot` = 超时前的 `task_status` 值
   - `review_status` = 'timeout'
   - `promised_land` = 超时前的 `promised_land_snapshot` 值（如果存在）或 `promised_land` 值
   - 其他字段（`ware_sku`、`inventory_num`、`sales_num`、`sale_day`、`charge`、`label`）保存当前快照

### 3.4 任务重复处理逻辑

**场景：** 同一个SKU在 `inventory` 表中重新满足条件（label包含2或4），需要同步到 `task` 表

**处理规则：**

1. **如果任务在完成检查或审核中** (`task_status IN (4,5)`)
   - 操作：将任务状态重置为"任务正在进行中"
   - 重置字段：
     - `task_status` = 原 `promised_land_snapshot` 值（如果存在且不为NULL）或原 `promised_land` 值
     - `promised_land` = 原 `promised_land_snapshot` 值（如果存在且不为NULL）或原 `promised_land` 值
     - 清除：`promised_land_snapshot = NULL`、`checked_at = NULL`、`reviewed_at = NULL`、`review_status = NULL`、`reject_reason = NULL`
   - **重要：不更新 `created_at`，倒计时继续从原时间计算**
   - **重要：更新 `updated_at = CURRENT_TIMESTAMP`（用于记录数据同步时间）**

2. **如果任务已审核完成**（已在 `task_history` 表中）
   - 操作：在 `task` 表中创建新任务
   - 行为：正常创建新任务，`created_at` = 当前时间，倒计时重新开始

3. **如果任务在未选择方案或任务正在进行中** (`task_status IN (0,1,2,3)`)
   - 操作：正常更新任务数据（库存、销量、可售天数等）
   - 行为：保持现有状态，只更新数据字段

---

## 四、数据筛选与展示

### 4.1 大盘标签逻辑（数据库筛选）

**修改位置：** `lib/inventory-data.ts` 中的 `syncInventoryToTask()` 函数和 `app/actions/inventory.ts` 中的 `calculateInventoryData()` 函数

**原逻辑：**
- 非爆款：`sale_day > 15` 时打标签4
- 爆款：`sale_day > 30` 时打标签4

**新逻辑：**
- 统一：`sale_day > 20` 时打标签4（无论是否为爆款）

**实现方式：** 数据库筛选（在SQL查询中使用条件判断）

**SQL示例：**
```sql
-- 在 syncInventoryToTask 中
WHERE (label::jsonb @> '[4]'::jsonb)
   OR ((label::jsonb @> '[2]'::jsonb)
       AND NOT (label::jsonb @> '[1]'::jsonb)
       AND NOT (label::jsonb @> '[5]'::jsonb))
```

**代码修改位置：**
- `app/actions/inventory.ts` 第188-195行：修改标签4的判断条件
- `lib/inventory-data.ts` 第318-325行：同步逻辑保持不变（基于label字段）

### 4.2 任务列表筛选（数据库筛选）

**完成检查列表：**
```sql
SELECT * FROM task 
WHERE task_status = 4
ORDER BY checked_at DESC, updated_at DESC
```

**审核列表：**
```sql
SELECT * FROM task 
WHERE task_status = 5
ORDER BY reviewed_at DESC, updated_at DESC
```

**任务正在进行中列表：**
```sql
SELECT * FROM task 
WHERE task_status IN (1, 2, 3) 
  AND promised_land IN (1, 2, 3)
ORDER BY updated_at DESC
```

**实现方式：** 数据库筛选（在 `getTaskData()` 函数中增加 `task_status` 筛选条件）

### 4.3 前端展示逻辑

**完成检查展示框：**
- 显示字段：SKU货号、库存数量、最近七天销量、可售天数、负责人、标识、**方案（固定，只读）**、倒计时、**确定按钮**
- 方案字段：从 `promised_land_snapshot` 读取，不可修改

**审核展示框：**
- 显示字段：与完成检查相同，但**方案字段可查看**（仍为固定值）
- 确定按钮：点击后弹出对话框，选择"打回"或"已完成"
- 打回：需要填写打回理由（必填）
- 已完成：直接进入历史任务

**实现方式：** 前端计算（根据 `task_status` 字段判断显示哪个列表）

---

## 五、关键实现点

### 5.1 方案字段固定逻辑

**问题：** 完成检查和审核中的方案字段需要固定，不允许修改

**解决方案：**
1. 从"任务正在进行中"转入"完成检查"时，将当前的 `promised_land` 值保存到 `promised_land_snapshot`
2. 在完成检查和审核中，前端显示时使用 `promised_land_snapshot` 值
3. 在完成检查和审核中，禁用方案选择下拉框（只读显示）

### 5.2 管理员权限判断

**问题：** 审核功能仅管理员可见

**解决方案：**
1. 需要在用户认证系统中增加角色判断
2. 前端：根据用户角色决定是否显示"审核"展示框
3. 后端：在 `getTaskData()` 中，如果用户不是管理员，过滤掉 `task_status=5` 的记录

### 5.3 倒计时不更新逻辑

**问题：** 任务从完成检查/审核中流回任务正在进行中时，倒计时不更新

**解决方案：**
1. 在 `syncInventoryToTask()` 函数中，检测到任务状态为4或5时：
   - 不更新 `created_at` 字段
   - 保持原有的 `created_at` 值
   - 倒计时计算仍基于原 `created_at` 时间

### 5.4 超时自动处理

**问题：** 超时后自动转入未选择方案，并在历史任务中留下记录

**解决方案：**
1. 在 `updateTaskCountDown()` 函数执行后，检查是否有 `count_down < 0` 的记录
2. 对于超时的记录：
   - 如果 `task_status IN (1,2,3,4,5)`，执行超时处理
   - 重置 `promised_land=0`、`task_status=0`
   - 清除相关快照字段
   - 在 `task_history` 中创建记录

**实现位置：** 可以在定时任务中执行，或者在每次查询任务数据时检查

---

## 六、数据流转示例

### 示例1：正常流程

1. **初始状态：** SKU-A 进入任务表，`promised_land=0`，`task_status=0`
2. **选择方案：** 用户选择"退回厂家"，`promised_land=1`，`task_status=1`
3. **确认完成：** 用户点击"确认完成"按钮
   - `task_status=4`
   - `promised_land_snapshot=1`
   - `checked_at=当前时间`
4. **进入审核：** 用户点击"确认"按钮
   - `task_status=5`
   - `reviewed_at=当前时间`
5. **管理员审核：** 管理员选择"已完成"
   - 记录保存到 `task_history`
   - 从 `task` 表中删除

### 示例2：打回流程

1. **完成检查：** SKU-B 在完成检查中，`task_status=4`
2. **进入审核：** `task_status=5`
3. **管理员打回：** 管理员选择"打回"，填写理由"图片不清晰"
   - `task_status=4`（回到完成检查）
   - `review_status='rejected'`
   - `reject_reason='图片不清晰'`
   - `reviewed_at=当前时间`
4. **重新确认：** 用户可以重新点击"确认"，再次进入审核

### 示例3：超时处理

1. **任务正在进行中：** SKU-C，`promised_land=2`，`task_status=2`，`count_down=-5`（已超时5小时）
2. **自动处理：**
   - `promised_land=0`
   - `task_status=0`
   - 在 `task_history` 中创建记录：
     - `task_status_snapshot=2`
     - `review_status='timeout'`
     - `completed_at=当前时间`

### 示例4：任务重复出现

1. **场景：** SKU-D 在审核中（`task_status=5`），但 `inventory` 表中重新满足条件
2. **处理：**
   - 检测到 `task_status=5`
   - 重置为任务正在进行中：`task_status=原promised_land_snapshot值`
   - 清除：`promised_land_snapshot`、`checked_at`、`reviewed_at` 等
   - **不更新 `created_at`**，倒计时继续计算

---

## 七、前端界面调整

### 7.1 任务及时限页面结构调整

**原结构：**
- 未选择方案（可点击展示框）
- 任务正在进行中（可点击展示框）
- 超时任务（可点击展示框）

**新结构：**
- 未选择方案（可点击展示框）
- 任务正在进行中（可点击展示框）
- **完成检查（可点击展示框）** ← 新增
- **审核（可点击展示框）** ← 新增（仅管理员可见）
- 超时任务（可点击展示框）

### 7.2 完成检查列表字段

- SKU货号
- 库存数量
- 最近七天销量
- 可售天数
- 负责人
- 标识
- **方案（固定，只读）** ← 从 `promised_land_snapshot` 读取
- 倒计时
- **确定按钮** ← 新增

### 7.3 审核列表字段

- 与完成检查相同
- **确定按钮** ← 点击后弹出对话框
  - 选项1：打回（需要填写理由）
  - 选项2：已完成

---

## 八、总结

### 8.1 数据库字段变更汇总

**task表新增（6个字段）：**
- `task_status` (INTEGER, NOT NULL, DEFAULT 0) - 任务状态（0/1/2/3/4/5）
- `review_status` (VARCHAR(20), NULL) - 审核状态（NULL/ rejected/ approved）
- `reject_reason` (TEXT, NULL) - 打回理由
- `promised_land_snapshot` (INTEGER, NULL) - 方案快照（转入完成检查时保存）
- `checked_at` (TIMESTAMP, NULL) - 转入完成检查时间
- `reviewed_at` (TIMESTAMP, NULL) - 转入审核时间

**task_history表新增（3个字段）：**
- `review_status` (VARCHAR(20), NULL) - 审核状态快照（NULL/ rejected/ approved/ timeout）
- `reject_reason` (TEXT, NULL) - 打回理由快照
- `task_status_snapshot` (INTEGER, NULL) - 任务状态快照（完成时的task_status值）

**注意：** 
- `task` 表已有字段：`id`, `ware_sku`, `inventory_num`, `sales_num`, `sale_day`, `charge`, `label`, `promised_land`, `count_down`, `image_urls`, `created_at`, `updated_at`
- `task_history` 表已有字段：`id`, `ware_sku`, `completed_sale_day`, `charge`, `promised_land`, `completed_at`, `inventory_num`, `sales_num`, `label`

### 8.2 数据筛选方式

- **大盘标签逻辑：** 数据库筛选（SQL条件判断 `sale_day > 20`）
- **任务列表筛选：** 数据库筛选（SQL条件 `task_status`）
- **前端展示逻辑：** 前端计算（根据 `task_status` 判断显示内容）

### 8.3 关键流程

1. **任务流转：** 未选择方案 → 任务正在进行中 → 完成检查 → 审核 → 历史任务
2. **超时处理：** 自动重置为未选择方案，并在历史任务中记录
3. **任务重复：** 根据当前状态决定是重置还是新建任务

