# 如何检查索引创建状态

## 🔍 快速检查方法

### 方法一：查看索引列表（最简单）

**检查所有三个表的索引**：

```sql
-- 检查 inventory 表索引
SELECT 'inventory' AS 表名, indexname 
FROM pg_indexes 
WHERE tablename = 'inventory' 
  AND indexname LIKE 'idx_inventory%'
ORDER BY indexname;

-- 检查 task 表索引
SELECT 'task' AS 表名, indexname 
FROM pg_indexes 
WHERE tablename = 'task' 
  AND indexname LIKE 'idx_task%'
ORDER BY indexname;

-- 检查 task_history 表索引
SELECT 'task_history' AS 表名, indexname 
FROM pg_indexes 
WHERE tablename = 'task_history' 
  AND indexname LIKE 'idx_task_history%'
ORDER BY indexname;

-- 检查 post_searchs 表索引（海外物流模块）
SELECT 'post_searchs' AS 表名, indexname 
FROM pg_indexes 
WHERE tablename = 'post_searchs' 
  AND (indexname LIKE 'idx_post_searchs%' OR indexname IN ('idx_search_num', 'idx_states', 'idx_ship_date', 'idx_transfer_num', 'idx_order_num'))
ORDER BY indexname;
```

**预期结果**（如果创建成功）：

**inventory 表**（3 个索引）：
- idx_inventory_label_gin
- idx_inventory_updated_at_id
- idx_inventory_ware_sku

**task 表**（7 个索引）：
- idx_task_label_gin
- idx_task_ware_sku
- idx_task_promised_land
- idx_task_charge
- idx_task_created_at
- idx_task_updated_at_id
- idx_task_promised_land_charge

**task_history 表**（7 个索引）：
- idx_task_history_ware_sku
- idx_task_history_charge
- idx_task_history_promised_land
- idx_task_history_completed_at
- idx_task_history_label_gin
- idx_task_history_completed_at_promised_land
- idx_task_history_charge_completed_at

**post_searchs 表**（5 个新索引，基础索引可能已存在）：
- idx_post_searchs_ship_date_id（排序索引，最重要）
- idx_post_searchs_states_ship_date（状态+日期复合索引）
- idx_post_searchs_ship_date_states（日期+状态复合索引）
- idx_post_searchs_updated_at（更新时间索引）
- idx_post_searchs_states_ship_date_id（状态+日期+ID复合索引）

**如果看到所有索引** → ✅ **创建成功！**

**如果只看到部分索引** → ⏳ **还在创建中，请等待**

**如果看不到任何索引** → ❌ **创建失败或未开始**

---

### 方法二：查看正在创建的索引

**如果使用 CONCURRENTLY，可以在另一个查询窗口执行**：

```sql
SELECT 
    pid,
    now() - pg_stat_activity.query_start AS duration,
    state,
    query
FROM pg_stat_activity
WHERE query LIKE '%CREATE INDEX%'
  AND state = 'active'
ORDER BY query_start;
```

**结果说明**：
- **有结果**：索引还在创建中，`duration` 显示已执行的时间
- **无结果**：索引创建已完成或未开始

---

### 方法三：一键检查脚本（推荐）

**执行 `sql/postgresql/check_index_status.sql` 文件中的"快速检查脚本"**，可以一次性查看所有三个表的索引状态：

```sql
-- 一键检查所有表的索引状态
-- 执行 sql/postgresql/check_index_status.sql 中的查询
```

**预期结果**：
```
表名        | 索引说明                    | 索引名称                          | 状态
-----------|----------------------------|----------------------------------|--------
inventory  | ✅ GIN 索引（最重要）        | idx_inventory_label_gin           | ✅ 已创建
inventory  | ✅ 排序索引                 | idx_inventory_updated_at_id       | ✅ 已创建
inventory  | ✅ SKU 索引                 | idx_inventory_ware_sku            | ✅ 已创建
task       | ✅ GIN 索引（最重要）        | idx_task_label_gin                | ✅ 已创建
task       | ✅ SKU 索引                 | idx_task_ware_sku                 | ✅ 已创建
task       | ✅ 状态索引                 | idx_task_promised_land            | ✅ 已创建
task       | ✅ 负责人索引               | idx_task_charge                   | ✅ 已创建
task       | ✅ 创建时间索引             | idx_task_created_at               | ✅ 已创建
task       | ✅ 排序索引                 | idx_task_updated_at_id            | ✅ 已创建
task       | ✅ 复合索引                 | idx_task_promised_land_charge     | ✅ 已创建
task_history | ✅ SKU 索引               | idx_task_history_ware_sku         | ✅ 已创建
task_history | ✅ 负责人索引             | idx_task_history_charge           | ✅ 已创建
task_history | ✅ 方案索引               | idx_task_history_promised_land     | ✅ 已创建
task_history | ✅ 完成时间索引（最重要） | idx_task_history_completed_at      | ✅ 已创建
task_history | ✅ GIN 索引               | idx_task_history_label_gin        | ✅ 已创建
task_history | ✅ 复合索引1              | idx_task_history_completed_at_promised_land | ✅ 已创建
task_history | ✅ 复合索引2              | idx_task_history_charge_completed_at | ✅ 已创建
```

**总共应该有 22 个索引**（inventory: 3个，task: 7个，task_history: 7个，post_searchs: 5个新索引）

**注意**：`post_searchs` 表可能已有基础索引（idx_search_num, idx_states, idx_ship_date, idx_transfer_num, idx_order_num），这些是之前创建的，不在本次创建的 5 个新索引中。

---

### 方法四：测试索引是否生效

**执行以下查询，查看是否使用了索引**：

```sql
EXPLAIN ANALYZE
SELECT COUNT(*) FROM inventory WHERE label::jsonb @> '[4]'::jsonb;
```

**查看查询计划**：

**如果索引生效**，会看到：
```
Index Scan using idx_inventory_label_gin on inventory
```

**如果索引未生效**，会看到：
```
Seq Scan on inventory  ← 顺序扫描（慢）
```

---

## ⏱️ 创建时间参考

| 数据量 | GIN 索引创建时间 | 其他索引创建时间 | 总索引数 |
|--------|----------------|----------------|---------|
| 1 万条 | 10-30 秒/表 | 1-5 秒/索引 | 22 个索引 |
| 10 万条 | 1-5 分钟/表 | 5-15 秒/索引 | 预计 15-25 分钟 |
| 100 万条 | 10-30 分钟/表 | 30 秒-2 分钟/索引 | 预计 1.5-2.5 小时 |

**注意**：由于使用了 `CONCURRENTLY`，索引创建不会锁表，但创建时间会更长。

---

## 🎯 判断标准

### ✅ 创建成功的标志

1. **查询索引列表**：能看到 3 个索引
2. **索引大小**：`index_size > 0`（说明索引已创建）
3. **测试查询**：`EXPLAIN` 显示使用了索引

### ⏳ 还在创建中的标志

1. **查询索引列表**：看不到或只看到部分索引
2. **查看活动查询**：能看到 `CREATE INDEX` 正在执行
3. **等待时间**：还在预计创建时间内

### ❌ 创建失败的标志

1. **查询索引列表**：看不到索引
2. **查看活动查询**：没有 `CREATE INDEX` 在执行
3. **错误信息**：执行时出现错误（如权限不足、磁盘空间不足等）

---

## 🔧 如果创建失败

### 常见错误及解决方案

#### 错误 1：权限不足
```
ERROR: permission denied to create index
```
**解决**：使用有创建索引权限的用户

#### 错误 2：索引已存在
```
ERROR: relation "idx_inventory_label_gin" already exists
```
**解决**：使用 `IF NOT EXISTS`（已包含在脚本中）

#### 错误 3：CONCURRENTLY 失败
```
ERROR: CREATE INDEX CONCURRENTLY cannot be executed inside a transaction block
```
**解决**：确保不在事务块中执行，或者去掉 `CONCURRENTLY`

---

## 📝 总结

**最简单的检查方法**：

```sql
-- 检查所有三个表的索引
SELECT tablename, COUNT(*) as 索引数量
FROM pg_indexes 
WHERE tablename IN ('inventory', 'task', 'task_history')
  AND (indexname LIKE 'idx_inventory%' 
    OR indexname LIKE 'idx_task%' 
    OR indexname LIKE 'idx_task_history%')
GROUP BY tablename;
```

**预期结果**：
```
tablename     | 索引数量
--------------|--------
inventory     | 3
task          | 7
task_history  | 7
```

**如果看到 22 个新索引（3+7+7+5）** → ✅ **创建成功！**

**注意**：`post_searchs` 表的基础索引（idx_search_num, idx_states, idx_ship_date 等）可能已存在，不在本次创建的 5 个新索引中。

**如果数量不足** → ⏳ **还在创建中或创建失败**

**推荐使用**：执行 `sql/postgresql/check_index_status.sql` 中的"快速检查脚本"，可以查看详细的索引状态。

