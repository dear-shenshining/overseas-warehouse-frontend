# æ»é”€åº“å­˜ç®¡ç† - ä»»åŠ¡åŠæ—¶é™ å€’è®¡æ—¶åŠŸèƒ½å®ç°è¯´æ˜

## ğŸ“‹ åŠŸèƒ½æ¦‚è¿°

å€’è®¡æ—¶åŠŸèƒ½ç”¨äºæ˜¾ç¤ºä»»åŠ¡ä»åˆ›å»ºåˆ°æˆªæ­¢æ—¥æœŸçš„å‰©ä½™å¤©æ•°ï¼Œæ ¹æ®æ˜¯å¦é€‰æ‹©æ–¹æ¡ˆä½¿ç”¨ä¸åŒçš„è®¡ç®—é€»è¾‘ã€‚

---

## ğŸ”¢ å€’è®¡æ—¶è®¡ç®—é€»è¾‘

### è®¡ç®—å…¬å¼

å€’è®¡æ—¶æ ¹æ® `promised_land`ï¼ˆæ–¹æ¡ˆï¼‰å­—æ®µçš„å€¼ä½¿ç”¨ä¸åŒçš„è®¡ç®—æ–¹å¼ï¼š

| promised_land | è¯´æ˜ | å€’è®¡æ—¶å…¬å¼ |
|--------------|------|-----------|
| **0** | æœªé€‰æ‹©æ–¹æ¡ˆ | `count_down = 1 - (å½“å‰æ—¶é—´ - created_atçš„å¤©æ•°å·®)` |
| **1, 2, 3** | å·²é€‰æ‹©æ–¹æ¡ˆï¼ˆé€€å›å‚å®¶/é™ä»·æ¸…ä»“/æ‰“å¤„ç†ï¼‰ | `count_down = 7 - (å½“å‰æ—¶é—´ - created_atçš„å¤©æ•°å·®)` |

### è®¡ç®—ç¤ºä¾‹

**æœªé€‰æ‹©æ–¹æ¡ˆï¼ˆpromised_land = 0ï¼‰**ï¼š
- ä»»åŠ¡åˆ›å»ºåç¬¬ 0 å¤©ï¼š`count_down = 1 - 0 = 1` å¤©
- ä»»åŠ¡åˆ›å»ºåç¬¬ 1 å¤©ï¼š`count_down = 1 - 1 = 0` å¤©ï¼ˆæˆªæ­¢ï¼‰
- ä»»åŠ¡åˆ›å»ºåç¬¬ 2 å¤©ï¼š`count_down = 1 - 2 = -1` å¤©ï¼ˆè¶…æ—¶ï¼‰

**å·²é€‰æ‹©æ–¹æ¡ˆï¼ˆpromised_land = 1/2/3ï¼‰**ï¼š
- ä»»åŠ¡åˆ›å»ºåç¬¬ 0 å¤©ï¼š`count_down = 7 - 0 = 7` å¤©
- ä»»åŠ¡åˆ›å»ºåç¬¬ 3 å¤©ï¼š`count_down = 7 - 3 = 4` å¤©
- ä»»åŠ¡åˆ›å»ºåç¬¬ 7 å¤©ï¼š`count_down = 7 - 7 = 0` å¤©ï¼ˆæˆªæ­¢ï¼‰
- ä»»åŠ¡åˆ›å»ºåç¬¬ 8 å¤©ï¼š`count_down = 7 - 8 = -1` å¤©ï¼ˆè¶…æ—¶ï¼‰

---

## ğŸ’» ä»£ç å®ç°

### 1. æ•°æ®åº“æ›´æ–°å‡½æ•°

**æ–‡ä»¶**ï¼š`lib/inventory-data.ts`

**å‡½æ•°**ï¼š`updateTaskCountDown()`

```typescript
/**
 * æ›´æ–° task è¡¨ä¸­æ‰€æœ‰è®°å½•çš„ count_down å­—æ®µ
 * æ ¹æ® promised_land çš„å€¼ä½¿ç”¨ä¸åŒçš„è®¡ç®—é€»è¾‘ï¼š
 * - promised_land = 0 æ—¶ï¼šcount_down = 1 - DATEDIFF(NOW(), created_at)
 * - promised_land != 0 æ—¶ï¼šcount_down = 7 - DATEDIFF(NOW(), created_at)
 */
export async function updateTaskCountDown(): Promise<{ success: boolean; error?: string }> {
  // ä½¿ç”¨ SQL çš„ CASE WHEN æ ¹æ® promised_land çš„å€¼é€‰æ‹©ä¸åŒçš„è®¡ç®—æ–¹å¼
  await connection.query(
    `UPDATE task SET count_down = CASE 
      WHEN promised_land = 0 THEN 1 - EXTRACT(DAY FROM (CURRENT_TIMESTAMP - created_at))::INTEGER
      ELSE 7 - EXTRACT(DAY FROM (CURRENT_TIMESTAMP - created_at))::INTEGER
    END
    WHERE created_at IS NOT NULL`
  )
}
```

### 2. æŸ¥è¯¢æ—¶å®æ—¶è®¡ç®—

**æ–‡ä»¶**ï¼š`lib/inventory-data.ts`

**å‡½æ•°**ï¼š`getTaskData()`

åœ¨æŸ¥è¯¢ä»»åŠ¡æ•°æ®æ—¶ï¼ŒSQL è¯­å¥ä¸­ä¼šå®æ—¶è®¡ç®—å€’è®¡æ—¶ï¼š

```typescript
let sql =
  'SELECT id, ware_sku, inventory_num, sales_num, sale_day, charge, label, promised_land, 
   CASE WHEN promised_land = 0 
     THEN 1 - EXTRACT(DAY FROM (CURRENT_TIMESTAMP - created_at))::INTEGER 
     ELSE 7 - EXTRACT(DAY FROM (CURRENT_TIMESTAMP - created_at))::INTEGER 
   END as count_down, 
   created_at, updated_at 
   FROM task WHERE 1=1'
```

### 3. æ›´æ–°æ–¹æ¡ˆæ—¶åŒæ­¥æ›´æ–°å€’è®¡æ—¶

**æ–‡ä»¶**ï¼š`lib/inventory-data.ts`

**å‡½æ•°**ï¼š`updateTaskPromisedLand()`

å½“ç”¨æˆ·é€‰æ‹©æ–¹æ¡ˆæ—¶ï¼Œä¼šåŒæ—¶æ›´æ–°å€’è®¡æ—¶ï¼š

```typescript
await execute(
  `UPDATE task SET 
    promised_land = $1, 
    count_down = CASE 
      WHEN $1 = 0 THEN 1 - EXTRACT(DAY FROM (CURRENT_TIMESTAMP - created_at))::INTEGER
      ELSE 7 - EXTRACT(DAY FROM (CURRENT_TIMESTAMP - created_at))::INTEGER
    END,
    updated_at = CURRENT_TIMESTAMP
  WHERE ware_sku = $2`,
  [promisedLand, wareSku]
)
```

### 4. å‰ç«¯æ˜¾ç¤º

**æ–‡ä»¶**ï¼š`components/task-timeline.tsx`

åœ¨è¡¨æ ¼ä¸­ç›´æ¥æ˜¾ç¤º `count_down` å­—æ®µçš„å€¼ï¼š

```typescript
<td className="px-6 py-4 text-sm text-muted-foreground">
  {record.count_down !== null && record.count_down !== undefined ? record.count_down : 0}
</td>
```

---

## ğŸ”„ æ›´æ–°æœºåˆ¶

### 1. æŸ¥è¯¢æ—¶è‡ªåŠ¨æ›´æ–°ï¼ˆä¸»è¦æ–¹å¼ï¼‰

æ¯æ¬¡æŸ¥è¯¢ä»»åŠ¡æ•°æ®æ—¶ï¼Œä¼šæ‰§è¡Œä»¥ä¸‹æ“ä½œï¼š

**æ­¥éª¤ 1**ï¼šå…ˆæ›´æ–°æ•°æ®åº“ä¸­çš„ `count_down` å­—æ®µ
```typescript
// å…ˆæ›´æ–°æ‰€æœ‰è®°å½•çš„ count_down
await updateTaskCountDown()
```

**æ­¥éª¤ 2**ï¼šåœ¨ SQL æŸ¥è¯¢ä¸­å®æ—¶è®¡ç®—å€’è®¡æ—¶
```sql
SELECT ...,
  CASE WHEN promised_land = 0 
    THEN 1 - EXTRACT(DAY FROM (CURRENT_TIMESTAMP - created_at))::INTEGER 
    ELSE 7 - EXTRACT(DAY FROM (CURRENT_TIMESTAMP - created_at))::INTEGER 
  END as count_down
FROM task
```

**è¯´æ˜**ï¼š
- SQL ä¸­ä½¿ç”¨ `CURRENT_TIMESTAMP`ï¼Œæ¯æ¬¡æŸ¥è¯¢æ—¶éƒ½ä¼šæ ¹æ®å½“å‰æ—¶é—´å®æ—¶è®¡ç®—
- å³ä½¿æ•°æ®åº“ä¸­çš„ `count_down` å­—æ®µæ²¡æœ‰æ›´æ–°ï¼ŒæŸ¥è¯¢ç»“æœä¹Ÿä¼šæ˜¾ç¤ºæ­£ç¡®çš„å€’è®¡æ—¶å€¼

### 2. è§¦å‘æ›´æ–°çš„åœºæ™¯

å€’è®¡æ—¶åœ¨ä»¥ä¸‹æƒ…å†µä¸‹ä¼šæ›´æ–°ï¼š

| åœºæ™¯ | è§¦å‘æ–¹å¼ | è¯´æ˜ |
|------|---------|------|
| **é¡µé¢åŠ è½½** | `useEffect` è§¦å‘ `loadTaskData()` | è¿›å…¥"ä»»åŠ¡åŠæ—¶é™"é¡µé¢æ—¶ |
| **ç­›é€‰å˜åŒ–** | `labelFilter`ã€`statusFilter`ã€`chargeFilter` å˜åŒ– | ç‚¹å‡»ç»Ÿè®¡å¡ç‰‡ç­›é€‰æ—¶ |
| **æœç´¢æ“ä½œ** | ç”¨æˆ·ç‚¹å‡»æœç´¢æŒ‰é’® | æœç´¢ SKU æ—¶ |
| **æ‰‹åŠ¨åˆ·æ–°** | ç‚¹å‡»"åˆ·æ–°"æŒ‰é’®ï¼Œè°ƒç”¨ `refreshTaskTable()` | æ‰‹åŠ¨è§¦å‘æ•°æ®åˆ·æ–° |
| **é€‰æ‹©æ–¹æ¡ˆ** | ç”¨æˆ·é€‰æ‹©æ–¹æ¡ˆï¼Œè°ƒç”¨ `updateTaskPromisedLand()` | é€‰æ‹©æ–¹æ¡ˆæ—¶åŒæ­¥æ›´æ–°å€’è®¡æ—¶ |

### 3. å‰ç«¯æ²¡æœ‰å®šæ—¶è‡ªåŠ¨æ›´æ–°

**é‡è¦**ï¼šå‰ç«¯ä»£ç ä¸­**æ²¡æœ‰**ä½¿ç”¨ `setInterval` æˆ– `setTimeout` å®ç°å®šæ—¶è‡ªåŠ¨æ›´æ–°ã€‚

å€’è®¡æ—¶åªåœ¨ç”¨æˆ·æ“ä½œï¼ˆæŸ¥è¯¢ã€ç­›é€‰ã€åˆ·æ–°ï¼‰æ—¶æ›´æ–°ï¼Œä¸æ˜¯å®æ—¶è‡ªåŠ¨æ›´æ–°çš„ã€‚

---

## ğŸ“Š çŠ¶æ€åˆ¤æ–­

å€’è®¡æ—¶å€¼ç”¨äºåˆ¤æ–­ä»»åŠ¡çŠ¶æ€ï¼š

| count_down å€¼ | çŠ¶æ€ | è¯´æ˜ |
|--------------|------|------|
| `> 0` | è¿›è¡Œä¸­ | ä»»åŠ¡ä»åœ¨æœ‰æ•ˆæœŸå†… |
| `= 0` | æˆªæ­¢ | ä»»åŠ¡åˆšå¥½åˆ°æœŸ |
| `< 0` | è¶…æ—¶ | ä»»åŠ¡å·²è¶…è¿‡æˆªæ­¢æ—¥æœŸ |

åœ¨ç»Ÿè®¡å’Œç­›é€‰åŠŸèƒ½ä¸­ï¼š
- **è¶…æ—¶ä»»åŠ¡**ï¼š`count_down < 0`
- **ä»»åŠ¡æ­£åœ¨è¿›è¡Œä¸­**ï¼š`promised_land IN (1, 2, 3)` ä¸” `count_down >= 0`

---

## ğŸ” æŠ€æœ¯ç»†èŠ‚

### PostgreSQL æ—¥æœŸè®¡ç®—

ä½¿ç”¨ PostgreSQL çš„ `EXTRACT(DAY FROM ...)` å‡½æ•°è®¡ç®—æ—¥æœŸå·®ï¼š

```sql
EXTRACT(DAY FROM (CURRENT_TIMESTAMP - created_at))::INTEGER
```

### æ•°æ®ç±»å‹

- `count_down`ï¼šæ•´æ•°ç±»å‹ï¼ˆINTEGERï¼‰
- å¯ä»¥ä¸ºè´Ÿæ•°ï¼ˆè¡¨ç¤ºè¶…æ—¶ï¼‰
- é»˜è®¤å€¼ä¸º 0ï¼ˆå¦‚æœ `created_at` ä¸ºç©ºï¼‰

---

## ğŸ“ æ€»ç»“

å€’è®¡æ—¶åŠŸèƒ½çš„å®ç°ç‰¹ç‚¹ï¼š

1. **åŠ¨æ€è®¡ç®—**ï¼šæ ¹æ® `promised_land` å€¼ä½¿ç”¨ä¸åŒå…¬å¼
   - æœªé€‰æ‹©æ–¹æ¡ˆï¼š1 å¤©æˆªæ­¢
   - å·²é€‰æ‹©æ–¹æ¡ˆï¼š7 å¤©æˆªæ­¢

2. **æŸ¥è¯¢æ—¶æ›´æ–°**ï¼šæ¯æ¬¡æŸ¥è¯¢æ•°æ®æ—¶è‡ªåŠ¨è®¡ç®—å’Œæ›´æ–°å€’è®¡æ—¶
   - å…ˆæ›´æ–°æ•°æ®åº“ä¸­çš„ `count_down` å­—æ®µ
   - SQL æŸ¥è¯¢ä¸­ä½¿ç”¨ `CURRENT_TIMESTAMP` å®æ—¶è®¡ç®—

3. **çŠ¶æ€åˆ¤æ–­**ï¼šé€šè¿‡å€’è®¡æ—¶å€¼åˆ¤æ–­ä»»åŠ¡æ˜¯å¦è¶…æ—¶
   - `count_down > 0`ï¼šè¿›è¡Œä¸­
   - `count_down = 0`ï¼šæˆªæ­¢
   - `count_down < 0`ï¼šè¶…æ—¶

4. **ç”¨æˆ·å‹å¥½**ï¼šé€‰æ‹©æ–¹æ¡ˆåè‡ªåŠ¨å»¶é•¿å€’è®¡æ—¶ï¼ˆä» 1 å¤©å˜ä¸º 7 å¤©ï¼‰

5. **éå®æ—¶æ›´æ–°**ï¼šå‰ç«¯æ²¡æœ‰å®šæ—¶å™¨ï¼Œå€’è®¡æ—¶åªåœ¨ç”¨æˆ·æ“ä½œæ—¶æ›´æ–°ï¼ˆæŸ¥è¯¢ã€ç­›é€‰ã€åˆ·æ–°ï¼‰

