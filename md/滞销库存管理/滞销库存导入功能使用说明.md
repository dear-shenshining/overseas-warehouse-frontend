# 滞销库存导入功能使用说明

## 📋 功能概述

滞销库存管理页面的Excel导入功能已经实现，可以将Excel文件中的库存和销售数据导入到数据库的`inventory`表中。

---

## 🚀 使用步骤

### 第一步：创建数据库表

在导入数据之前，需要先创建`inventory`表和`task`表。执行以下SQL语句：

```sql
-- 在MySQL数据库中执行
source sql/create_inventory_table.sql
source sql/create_task_table.sql
```

或者直接在MySQL客户端中执行相应的SQL文件。

**说明：**
- `inventory` 表：存储所有库存数据
- `task` 表：自动同步符合条件的任务数据（label 包含 4 或 label 包含 2 但不包含 1 且不包含 5）

### 第二步：准备Excel文件

确保Excel文件包含以下列：
- **马帮SKU** - 商品的唯一标识符
- **仓库** - 仓库名称
- **库存数量** - 当前库存数量
- **待发货量** - 待发货的数量
- **在途量** - 在途中的数量
- **最近7天销量** - 最近7天的销售数量

**注意：** 所有仓库的数据都会被处理并汇总。

### 第三步：导入数据

1. 打开滞销库存管理页面（大盘页面）
2. 点击"导入数据"按钮
3. 选择Excel文件（`.xlsx`或`.xls`格式）
4. 等待导入完成
5. 查看导入结果提示

**注意：** 导入完成后会自动同步数据到 `task` 表。

### 第四步：刷新任务表（可选）

如果需要手动刷新任务表，可以：
1. 在"滞销库存管理 - 大盘"页面标题右侧
2. 点击"刷新"按钮
3. 系统会重新从 `inventory` 表同步符合条件的记录到 `task` 表

---

## 📊 数据处理规则

### 数据计算

系统会按照以下规则处理数据：

1. **按SKU分组**：将Excel中相同"马帮SKU"的数据分组
2. **汇总所有仓库**：所有仓库的数据都会被汇总计算
3. **计算库存数量**：
   ```
   inventory_num = SUM(所有仓库的库存数量) - SUM(所有仓库的待发货量) + SUM(所有仓库的在途量)
   ```
4. **计算销量**：
   ```
   sales_num = SUM(所有仓库的最近7天销量)
   ```
5. **计算可售天数**：
   ```
   sale_day = inventory_num * 7 / sales_num（如果 sales_num > 0）
   ```
6. **生成标签**：根据库存数量、销量、可售天数自动生成标签
7. **同步任务表**：导入完成后，自动将符合条件的记录同步到 `task` 表（label 包含 4 或 label 包含 2 但不包含 1 且不包含 5）

### 数据库操作

- **如果SKU已存在**：更新`inventory_num`、`sales_num`、`sale_day`和`label`字段，`charge`字段保持不变（如果已存在）
- **如果SKU不存在**：插入新记录，所有字段根据计算和匹配规则设置
- **自动同步任务表**：导入完成后，自动将符合条件的记录同步到 `task` 表

---

## ⚠️ 注意事项

1. **文件格式**：只支持`.xlsx`和`.xls`格式的Excel文件
2. **文件大小**：文件大小不能超过10MB
3. **列名要求**：Excel文件必须包含所有必要的列（见上方列表）
4. **数据完整性**：
   - "马帮SKU"不能为空
   - 数值字段必须是有效数字
   - 如果某个SKU在指定仓库中没有数据，计算结果为0

---

## 🔍 故障排查

### 问题1：导入失败，提示"Excel文件缺少必要的列"

**原因：** Excel文件的列名不匹配

**解决方案：**
- 检查Excel文件的列名是否完全匹配：
  - 马帮SKU
  - 仓库
  - 库存数量
  - 待发货量
  - 在途量
  - 最近7天销量

### 问题2：导入失败，提示"没有找到有效的数据"

**原因：** 没有找到满足条件的数据

**解决方案：**
- 检查Excel文件中是否有数据
- 检查"马帮SKU"列是否有值

### 问题3：导入失败，提示数据库错误

**原因：** 数据库连接或表结构问题

**解决方案：**
1. 检查数据库连接配置（`lib/db.ts`）
2. 确认`inventory`表已创建
3. 检查表结构是否正确
4. 查看控制台错误信息

---

## 📝 技术实现

### 文件结构

```
lib/
  └── inventory-data.ts      # 数据库操作模块
app/
  └── actions/
      └── inventory.ts       # Server Actions（Excel解析和导入）
components/
  └── slow-moving-inventory.tsx  # 前端组件（文件上传）
sql/
  └── create_inventory_table.sql  # 数据库表创建SQL
```

### 数据流程

```
用户选择Excel文件
    ↓
前端验证文件格式和大小
    ↓
上传文件到Server Action
    ↓
解析Excel文件（xlsx库）
    ↓
验证列名和数据完整性
    ↓
按"马帮SKU"分组数据
    ↓
汇总所有仓库的数据
    ↓
计算inventory_num、sales_num、sale_day和label
    ↓
开始数据库事务
    ↓
对每个SKU：检查是否存在 → UPDATE或INSERT
    ↓
提交事务
    ↓
同步数据到 task 表（label 包含 4 或 label 包含 2 但不包含 1 且不包含 5）
    ↓
返回导入结果
    ↓
前端显示结果
```

---

## ✅ 功能检查清单

- [x] 创建数据库表`inventory`
- [x] 实现Excel文件解析
- [x] 实现数据计算逻辑
- [x] 实现数据库批量导入
- [x] 实现前端文件上传功能
- [x] 添加错误处理和用户提示
- [x] 添加导入进度提示

---

## 🎯 下一步

导入功能已实现，后续可以：

1. **显示导入的数据**：在页面上显示已导入的库存数据
2. **搜索功能**：实现按SKU搜索库存数据
3. **导出功能**：将数据库中的库存数据导出为Excel文件
4. **数据统计**：显示库存统计信息（总库存、总销量等）

---

## 📞 技术支持

如果遇到问题，请检查：
1. 控制台错误信息
2. 数据库连接状态
3. Excel文件格式和内容
4. 数据库表结构

