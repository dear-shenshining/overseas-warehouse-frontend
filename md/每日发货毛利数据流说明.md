# 每日发货毛利数据流说明

## 概述

本文档说明每日发货毛利模块的完整数据流向，从Excel导入到数据库存储，再到前端展示的全流程。

## 数据流程图

```
Excel文件 
  ↓
前端上传 (components/daily-profit-report.tsx)
  ↓
Server Action (app/actions/orders.ts - importOrdersFile)
  ↓
Excel解析 (app/actions/orders.ts - parseExcelFile, convertToOrdersData)
  ↓
数据处理 (lib/orders-data.ts - importOrdersData)
  ├─ 运费匹配 (lib/orders-data.ts - getShippingFeeByChannel)
  ├─ 计算商品及运费成本 (total_product_cost + actual_shipping_fee)
  ├─ 计算毛利 (total_amount - product_and_shipping_cost)
  └─ 计算利润率 ((profit / product_and_shipping_cost) * 100%)
  ↓
PostgreSQL数据库 (orders表)
  ↓
数据查询 (lib/orders-data.ts - getOrdersData, getOrdersStatistics)
  ↓
Server Action (app/actions/orders.ts - fetchOrdersStatistics, fetchStoreList)
  ↓
前端展示 (components/daily-profit-report.tsx)
```

## 详细数据流

### 1. Excel文件导入阶段

#### 1.1 前端上传
**文件**: `components/daily-profit-report.tsx`

```typescript
// 用户选择Excel文件后触发
const handleFileSelect = async (e: React.ChangeEvent<HTMLInputElement>) => {
  const file = e.target.files?.[0]
  const formData = new FormData()
  formData.append('file', file)
  
  // 调用Server Action导入
  const result = await importOrdersFile(formData)
}
```

**功能**:
- 文件类型验证（.xlsx, .xls）
- 文件大小验证（最大10MB）
- 创建FormData并调用Server Action

#### 1.2 Server Action接收
**文件**: `app/actions/orders.ts`

```typescript
export async function importOrdersFile(formData: FormData) {
  const file = formData.get('file') as File | null
  const arrayBuffer = await file.arrayBuffer()
  const buffer = Buffer.from(arrayBuffer)
  
  // 解析Excel文件
  const excelData = parseExcelFile(buffer)
  
  // 转换为订单数据
  const ordersData = convertToOrdersData(excelData)
  
  // 导入数据库
  const result = await importOrdersData(ordersData)
}
```

**Excel列名映射** (`EXCEL_COLUMNS`):
- `订单编号` → `order_number`
- `店铺名` → `store_name`
- `付款时间` → `payment_time`
- `平台SKU` → `platform_sku`
- `物流渠道` → `logistics_channel`
- `订单状态` → `order_status`
- `商品总成本` → `total_product_cost`
- `实际运费` → `actual_shipping_fee`
- `销售回款` → `sales_refund`
- `运费回款` → `shipping_refund`
- `总计金额` → `total_amount`

### 2. 数据处理阶段

#### 2.1 Excel数据解析
**文件**: `app/actions/orders.ts`

```typescript
function parseExcelFile(fileBuffer: Buffer): any[] {
  const workbook = XLSX.read(fileBuffer, { type: 'buffer' })
  const sheetName = workbook.SheetNames[0]
  const worksheet = workbook.Sheets[sheetName]
  const data = XLSX.utils.sheet_to_json(worksheet, { defval: null })
  return data
}
```

**功能**:
- 读取Excel文件的第一个工作表
- 转换为JSON数组
- 验证必要列是否存在（至少需要"订单编号"）

#### 2.2 数据转换
**文件**: `app/actions/orders.ts`

```typescript
function convertToOrdersData(excelData: any[]): OrderRecord[] {
  return excelData.map(row => ({
    order_number: String(row['订单编号']).trim(),
    store_name: row['店铺名'] ? String(row['店铺名']).trim() : null,
    payment_time: parseDate(row['付款时间']),
    // ... 其他字段
    total_product_cost: parseNumber(row['商品总成本'], 0),
    actual_shipping_fee: parseNumber(row['实际运费'], 0),
    // ...
  }))
}
```

**功能**:
- 将Excel行数据转换为订单对象
- 处理日期格式（支持Excel日期序列号）
- 处理数字格式
- 跳过订单编号为空的行

### 3. 数据库存储阶段

#### 3.1 运费匹配逻辑
**文件**: `lib/orders-data.ts`

```typescript
const LOGISTICS_CHANNEL_FEE_MAP: Record<string, number> = {
  '金焱焱海外仓日邮小包': 23,
  '大阪海外仓HW105黑猫小包': 23,
  '大阪海外仓HW105佐川': 23,
  '大阪海外仓HW105日邮': 23,
  '大阪海外仓HW105黑猫投函': 12,
  '金焱焱海外仓': 12,
}

export function getShippingFeeByChannel(
  logisticsChannel: string | null | undefined,
  currentFee: number | null | undefined
): number {
  // 如果运费不为0，直接返回原值
  if (currentFee !== null && currentFee !== undefined && currentFee !== 0) {
    return currentFee
  }
  
  // 如果运费为0或空，根据物流渠道匹配
  // 精确匹配或模糊匹配
  return LOGISTICS_CHANNEL_FEE_MAP[logisticsChannel] || 0
}
```

**规则**:
- 如果实际运费不为0，使用实际运费
- 如果实际运费为0，根据物流渠道自动匹配运费
- 支持精确匹配和模糊匹配

#### 3.2 计算衍生字段
**文件**: `lib/orders-data.ts` - `importOrdersData`

```typescript
for (const order of batch) {
  // 1. 处理运费：如果为0，根据物流渠道匹配
  const shippingFee = getShippingFeeByChannel(
    order.logistics_channel,
    order.actual_shipping_fee
  )
  
  // 2. 计算商品及运费成本 = 商品总成本 + 实际运费
  const productCost = order.total_product_cost || 0
  const productAndShippingCost = productCost + shippingFee
  
  // 3. 计算毛利 = 总计金额 - 商品及运费成本
  const totalAmount = order.total_amount || 0
  const profit = totalAmount - productAndShippingCost
  
  // 4. 计算利润率 = (毛利 / 商品及运费成本) * 100%
  const profitRate = productAndShippingCost > 0 
    ? Math.round((profit / productAndShippingCost * 100) * 100) / 100
    : 0
}
```

**计算字段**:
1. **product_and_shipping_cost** (商品及运费成本) = `total_product_cost + actual_shipping_fee`
2. **profit** (毛利) = `total_amount - product_and_shipping_cost`
3. **profit_rate** (利润率) = `(profit / product_and_shipping_cost) * 100%`

#### 3.3 批量插入数据库
**文件**: `lib/orders-data.ts` - `importOrdersData`

```typescript
// 使用 INSERT ... ON CONFLICT 进行批量插入/更新
const insertSql = `
  INSERT INTO orders (
    order_number, store_name, payment_time, platform_sku,
    logistics_channel, order_status, total_product_cost,
    actual_shipping_fee, product_and_shipping_cost,
    profit, profit_rate, sales_refund, shipping_refund, total_amount
  ) VALUES ${placeholders.join(', ')}
  ON CONFLICT (order_number) 
  DO UPDATE SET
    store_name = EXCLUDED.store_name,
    payment_time = EXCLUDED.payment_time,
    // ... 更新所有字段
    profit = EXCLUDED.profit,
    profit_rate = EXCLUDED.profit_rate,
    updated_at = CURRENT_TIMESTAMP
`
```

**特点**:
- 批量处理：每1000条一批
- 去重：根据订单编号，已存在的订单会更新，新订单会插入
- 自动计算：所有衍生字段在插入时自动计算

### 4. 数据查询阶段

#### 4.1 订单数据查询
**文件**: `lib/orders-data.ts` - `getOrdersData`

```typescript
export async function getOrdersData(
  dateFrom?: string,
  dateTo?: string,
  storeName?: string
): Promise<OrderRecord[]> {
  let sql = 'SELECT * FROM orders WHERE payment_time IS NOT NULL'
  
  // 日期筛选
  if (dateFrom) {
    sql += ` AND payment_time >= $${paramIndex}::date`
    params.push(dateFrom)
  }
  
  if (dateTo) {
    sql += ` AND payment_time < ($${paramIndex}::date + INTERVAL '1 day')`
    params.push(dateTo)
  }
  
  // 店铺筛选
  if (storeName && storeName !== 'all') {
    sql += ` AND store_name = $${paramIndex}`
    params.push(storeName)
  }
  
  return await query<OrderRecord>(sql, params)
}
```

**筛选条件**:
- **日期筛选**: 基于 `payment_time`（付款时间）字段
  - `dateFrom`: 开始日期（包含当天00:00:00）
  - `dateTo`: 结束日期（包含当天23:59:59）
- **店铺筛选**: 基于 `store_name`（店铺名）字段
  - `"all"`: 查询所有店铺
  - 其他值: 查询指定店铺

#### 4.2 统计数据计算
**文件**: `lib/orders-data.ts` - `getOrdersStatistics`

```typescript
export async function getOrdersStatistics(
  dateFrom?: string,
  dateTo?: string,
  storeName?: string
): Promise<{
  totalProfit: number        // 总毛利（profit字段的总和）
  totalShipping: number      // 总运费（actual_shipping_fee字段的总和）
  lowProfitRateCount: number // 毛利率低于20的数量
  noShippingRefundCount: number // 运费回款为0的数量
  dailyData: Array<{         // 每日数据
    date: string
    profit: number
    shipping: number
  }>
}> {
  const orders = await getOrdersData(dateFrom, dateTo, storeName)
  
  // 遍历订单，计算统计值
  orders.forEach((order) => {
    const profit = order.profit ?? 0
    const shipping = order.actual_shipping_fee ?? 0
    
    // 1. 累加总毛利
    totalProfit += profit
    
    // 2. 累加总运费
    totalShipping += shipping
    
    // 3. 统计毛利率低于20的数量
    if (order.profit_rate < 20) {
      lowProfitRateCount++
    }
    
    // 4. 统计运费回款为0的数量
    if (!order.shipping_refund || order.shipping_refund === 0) {
      noShippingRefundCount++
    }
    
    // 5. 按日期分组统计
    const date = extractDate(order.payment_time)
    dailyMap.get(date).profit += profit
    dailyMap.get(date).shipping += shipping
  })
  
  return { totalProfit, totalShipping, lowProfitRateCount, noShippingRefundCount, dailyData }
}
```

**统计指标**:
1. **总毛利**: 所有订单的 `profit` 字段总和
2. **总运费**: 所有订单的 `actual_shipping_fee` 字段总和
3. **毛利率低**: `profit_rate < 20` 的订单数量
4. **无运费补贴**: `shipping_refund = 0` 或 `null` 的订单数量
5. **每日数据**: 按 `payment_time` 的日期分组，统计每日的毛利和运费

**注意**: 所有统计都受 `dateFrom`、`dateTo`、`storeName` 筛选条件影响。

### 5. Server Action层

#### 5.1 获取统计数据
**文件**: `app/actions/orders.ts` - `fetchOrdersStatistics`

```typescript
export async function fetchOrdersStatistics(
  dateFrom?: string,
  dateTo?: string,
  storeName?: string
) {
  const { getOrdersStatistics } = await import('@/lib/orders-data')
  const stats = await getOrdersStatistics(dateFrom, dateTo, storeName)
  
  return {
    success: true,
    data: {
      totalProfit: stats.totalProfit,
      totalShipping: stats.totalShipping,
      lowProfitRateCount: stats.lowProfitRateCount,
      noShippingRefundCount: stats.noShippingRefundCount,
      dailyData: stats.dailyData,
    },
  }
}
```

#### 5.2 获取店铺列表
**文件**: `app/actions/orders.ts` - `fetchStoreList`

```typescript
export async function fetchStoreList() {
  const { getStoreList } = await import('@/lib/orders-data')
  const stores = await getStoreList()
  
  return {
    success: true,
    data: stores,
  }
}
```

**文件**: `lib/orders-data.ts` - `getStoreList`

```typescript
export async function getStoreList(): Promise<string[]> {
  const sql = `SELECT DISTINCT store_name 
               FROM orders 
               WHERE store_name IS NOT NULL AND store_name != '' 
               ORDER BY store_name`
  const results = await query<{ store_name: string }>(sql)
  return results.map(r => r.store_name)
}
```

### 6. 前端展示阶段

#### 6.1 数据加载
**文件**: `components/daily-profit-report.tsx`

```typescript
// 加载统计数据
useEffect(() => {
  const loadData = async () => {
    setLoading(true)
    const result = await fetchOrdersStatistics(
      dateFrom,
      dateTo,
      selectedStore === "all" ? undefined : selectedStore
    )
    
    if (result.success && result.data) {
      // 转换每日数据格式
      const formattedDailyData = result.data.dailyData.map(item => ({
        date: item.date,
        dateLabel: format(new Date(item.date), "MM-dd"),
        profit: item.profit,
        shipping: item.shipping,
      }))
      
      // 更新状态
      setDailyData(formattedDailyData)
      setStats({
        totalProfit: result.data.totalProfit,
        totalShipping: result.data.totalShipping,
        lowProfitRateCount: result.data.lowProfitRateCount,
        noShippingRefundCount: result.data.noShippingRefundCount,
        // ...
      })
    }
  }
  loadData()
}, [dateFrom, dateTo, selectedStore])
```

**触发时机**:
- 组件首次加载
- `dateFrom` 变化
- `dateTo` 变化
- `selectedStore` 变化

#### 6.2 统计卡片展示

**总毛利卡片**:
```typescript
<Card>
  <p>总毛利</p>
  <p>{formatCurrency(stats.totalProfit)}</p>
</Card>
```
- 显示: `profit` 字段的总和
- 受店铺和日期筛选影响

**总运费卡片**:
```typescript
<Card>
  <p>总运费</p>
  <p>{formatCurrency(stats.totalShipping)}</p>
  <p>占比 {shippingPercentage}%</p>
</Card>
```
- 显示: `actual_shipping_fee` 字段的总和
- 占比: `(totalShipping / totalProfit) * 100%`

**毛利率低卡片**:
```typescript
<Card>
  <p>毛利率低</p>
  <p>{stats.lowProfitRateCount}</p>
  <p>毛利率 &lt; 20%</p>
</Card>
```
- 显示: `profit_rate < 20` 的订单数量
- 受店铺和日期筛选影响

**无运费补贴卡片**:
```typescript
<Card>
  <p>无运费补贴</p>
  <p>{stats.noShippingRefundCount}</p>
  <p>运费回款为 0</p>
</Card>
```
- 显示: `shipping_refund = 0` 或 `null` 的订单数量
- 受店铺和日期筛选影响

#### 6.3 图表展示

```typescript
<ComposedChart data={dailyData}>
  <Bar dataKey="profit" name="profit" />      {/* 毛利柱状图 */}
  <Line dataKey="shipping" name="shipping" />  {/* 运费折线图 */}
</ComposedChart>
```

**数据来源**: `dailyData` 数组，按日期分组统计的每日毛利和运费

## 数据库表结构

**表名**: `orders`

**关键字段**:
- `order_number` (VARCHAR): 订单编号（唯一）
- `store_name` (VARCHAR): 店铺名
- `payment_time` (TIMESTAMP): 付款时间（用于日期筛选）
- `total_product_cost` (NUMERIC): 商品总成本
- `actual_shipping_fee` (NUMERIC): 实际运费
- `product_and_shipping_cost` (NUMERIC): 商品及运费成本（计算字段）
- `profit` (NUMERIC): 毛利（计算字段）
- `profit_rate` (NUMERIC): 利润率（计算字段）
- `shipping_refund` (NUMERIC): 运费回款
- `total_amount` (NUMERIC): 总计金额

**索引**:
- `idx_order_number`: 订单编号索引
- `idx_payment_time`: 付款时间索引（用于日期筛选）
- `idx_store_name`: 店铺名索引（用于店铺筛选）

## 关键文件说明

| 文件路径 | 功能 |
|---------|------|
| `components/daily-profit-report.tsx` | 前端展示组件，处理用户交互和数据展示 |
| `app/actions/orders.ts` | Server Actions，处理Excel导入和数据查询 |
| `lib/orders-data.ts` | 数据访问层，处理数据库操作和业务逻辑 |
| `sql/postgresql/create_orders_table.sql` | 创建订单表的SQL脚本 |
| `sql/postgresql/add_product_and_shipping_cost_to_orders.sql` | 添加商品及运费成本字段 |
| `sql/postgresql/add_profit_and_profit_rate_to_orders.sql` | 添加毛利和利润率字段 |

## 数据筛选逻辑

### 日期筛选
- **字段**: `payment_time`（付款时间）
- **格式**: `YYYY-MM-DD`（如 `2025-12-06`）
- **范围**: 
  - 开始日期: `payment_time >= dateFrom::date`（包含当天00:00:00）
  - 结束日期: `payment_time < (dateTo::date + INTERVAL '1 day')`（包含当天23:59:59）

### 店铺筛选
- **字段**: `store_name`（店铺名）
- **值**: 
  - `"all"`: 查询所有店铺
  - 其他值: 查询指定店铺（精确匹配）

### 筛选影响范围
所有统计指标都受筛选条件影响：
- ✅ 总毛利
- ✅ 总运费
- ✅ 毛利率低数量
- ✅ 无运费补贴数量
- ✅ 每日数据

## 注意事项

1. **日期格式**: `payment_time` 字段存储的是完整的日期时间（如 `2025-12-06 23:56:58`），查询时会自动转换为日期进行比较

2. **计算字段**: `profit`、`profit_rate`、`product_and_shipping_cost` 在导入时自动计算，不需要手动设置

3. **运费匹配**: 如果导入的Excel中"实际运费"为0，系统会根据"物流渠道"自动匹配运费

4. **数据更新**: 如果订单编号已存在，导入时会更新所有字段（包括计算字段）

5. **性能优化**: 使用批量插入（每1000条一批）和 `ON CONFLICT` 处理，提高导入性能







