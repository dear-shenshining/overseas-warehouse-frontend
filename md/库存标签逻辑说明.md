# 库存标签逻辑与分类说明

## 📋 目录

1. [标签定义](#标签定义)
2. [标签生成规则](#标签生成规则)
3. [分类逻辑](#分类逻辑)
4. [筛选条件](#筛选条件)
5. [特殊情况说明](#特殊情况说明)
6. [示例说明](#示例说明)

---

## 🏷️ 标签定义

库存数据使用数字标签进行分类标识，每个标签对应一个特定的业务含义：

| 标签数字 | 中文名称 | 说明 |
|---------|---------|------|
| 1 | 无库存 | 库存数量为0 |
| 2 | 无销量 | 最近7天销量为0 |
| 3 | 爆款 | 最近7天销量大于300 |
| 4 | 在售天数预警 | 可售天数超过阈值（根据是否有爆款标签决定） |
| 5 | 库存待冲平 | 库存数量为负数 |

**注意**：一条记录可以同时拥有多个标签，例如 `[1, 2]` 表示"无库存"且"无销量"。

---

## 🔢 标签生成规则

标签在导入Excel数据时自动生成，生成顺序如下：

### 1. 标签1 - 无库存

**条件**：`inventory_num === 0`

**说明**：当库存数量为0时，自动添加标签1。

**示例**：
- `inventory_num = 0` → 标签：`[1]`
- `inventory_num = 10` → 不添加标签1

---

### 2. 标签2 - 无销量

**条件**：`sales_num === 0`

**说明**：当最近7天销量为0时，自动添加标签2。

**示例**：
- `sales_num = 0` → 标签：`[2]`
- `sales_num = 50` → 不添加标签2

---

### 3. 标签3 - 爆款

**条件**：`sales_num > 300`

**说明**：当最近7天销量大于300时，自动添加标签3。

**示例**：
- `sales_num = 350` → 标签：`[3]`
- `sales_num = 300` → 不添加标签3（需要大于300）
- `sales_num = 100` → 不添加标签3

---

### 4. 标签4 - 在售天数预警

**条件**：根据是否有爆款标签（标签3）决定阈值

**规则**：
- **如果有爆款标签**（`sales_num > 300`）：
  - 需要 `sale_day > 30` 才添加标签4
- **如果没有爆款标签**（`sales_num <= 300`）：
  - 需要 `sale_day > 15` 才添加标签4

**说明**：爆款商品由于销量大，库存周转快，所以预警阈值更高（30天），而普通商品的预警阈值是15天。

**示例**：
- 爆款（销量500）+ 可售天数20天 → 标签：`[3]`（无标签4，因为20 < 30）
- 爆款（销量500）+ 可售天数35天 → 标签：`[3, 4]`（35 > 30）
- 非爆款（销量100）+ 可售天数20天 → 标签：`[4]`（20 > 15）
- 非爆款（销量100）+ 可售天数10天 → 标签：`[]`（无标签4，因为10 < 15）

---

### 5. 标签5 - 库存待冲平

**条件**：`inventory_num < 0`

**说明**：当库存数量为负数时，自动添加标签5。

**示例**：
- `inventory_num = -10` → 标签：`[5]`
- `inventory_num = 0` → 不添加标签5
- `inventory_num = 100` → 不添加标签5

---

## 📊 分类逻辑

系统提供5个统计卡片，用于分类查看不同状态的库存数据：

### 1. 正常销售

**筛选条件**：`label` 不包含 1、2、4、5

**说明**：显示所有正常销售的库存，即没有异常标签的商品。

**SQL筛选逻辑**：
```sql
WHERE (label IS NULL OR label = '[]' OR 
  (NOT JSON_CONTAINS(label, '1') AND NOT JSON_CONTAINS(label, '2') 
   AND NOT JSON_CONTAINS(label, '4') AND NOT JSON_CONTAINS(label, '5')))
```

**包含的数据**：
- 没有任何标签的记录
- 只有标签3（爆款）的记录
- 标签中只包含3的记录

---

### 2. 在售天数超15天

**筛选条件**：`label` 包含 4

**说明**：显示所有在售天数预警的商品，即标签中包含4的记录。

**SQL筛选逻辑**：
```sql
WHERE JSON_CONTAINS(label, '4') OR JSON_SEARCH(label, 'one', '4') IS NOT NULL
```

**包含的数据**：
- 非爆款且可售天数 > 15天的记录
- 爆款且可售天数 > 30天的记录

---

### 3. 无销量

**筛选条件**：`label` 包含 2

**说明**：显示所有无销量的商品，即最近7天销量为0的记录。

**SQL筛选逻辑**：
```sql
WHERE JSON_CONTAINS(label, '2') OR JSON_SEARCH(label, 'one', '2') IS NOT NULL
```

**包含的数据**：
- `sales_num = 0` 的所有记录
- 可能同时包含其他标签（如标签1、标签5等）

---

### 4. 库存待冲平

**筛选条件**：`label` 包含 5

**说明**：显示所有库存为负数的商品，需要冲平库存。

**SQL筛选逻辑**：
```sql
WHERE JSON_CONTAINS(label, '5') OR JSON_SEARCH(label, 'one', '5') IS NOT NULL
```

**包含的数据**：
- `inventory_num < 0` 的所有记录

---

### 5. 有库存无销量

**筛选条件**：`label` 包含 2 但不包含 1 且不包含 5

**说明**：显示有库存但无销量的商品，即库存数量大于0但最近7天销量为0的记录，排除库存待冲平的记录。

**SQL筛选逻辑**：
```sql
WHERE (JSON_CONTAINS(label, '2') OR JSON_SEARCH(label, 'one', '2') IS NOT NULL)
  AND (NOT JSON_CONTAINS(label, '1') AND JSON_SEARCH(label, 'one', '1') IS NULL)
  AND (NOT JSON_CONTAINS(label, '5') AND JSON_SEARCH(label, 'one', '5') IS NULL)
```

**包含的数据**：
- `inventory_num > 0` 且 `sales_num = 0` 的记录
- 不包括 `inventory_num = 0` 的记录（那些会被标签1覆盖）
- 不包括 `inventory_num < 0` 的记录（那些会被标签5覆盖）

---

## 🔍 筛选条件总结

| 分类名称 | 筛选条件 | 标签要求 |
|---------|---------|---------|
| 正常销售 | `label` 不包含 1、2、4、5 | 可以包含3（爆款），或不包含任何标签 |
| 在售天数超15天 | `label` 包含 4 | 必须包含标签4 |
| 无销量 | `label` 包含 2 | 必须包含标签2 |
| 库存待冲平 | `label` 包含 5 | 必须包含标签5 |
| 有库存无销量 | `label` 包含 2 但不包含 1 且不包含 5 | 必须包含标签2，且不包含标签1和标签5 |

---

## ⚠️ 特殊情况说明

### 1. 标签4的特殊逻辑

标签4（在售天数预警）的生成依赖于是否有标签3（爆款）：

- **有爆款标签时**：阈值提高到30天
  - 原因：爆款商品销量大，库存周转快，需要更高的预警阈值
- **无爆款标签时**：阈值为15天
  - 原因：普通商品库存周转较慢，15天即可预警

### 2. 标签组合示例

**常见标签组合**：

| 标签组合 | 含义 | 示例数据 |
|---------|------|---------|
| `[1, 2]` | 无库存且无销量 | `inventory_num=0, sales_num=0` |
| `[2, 4]` | 无销量且在售天数预警 | `inventory_num=100, sales_num=0, sale_day=20` |
| `[3, 4]` | 爆款且在售天数预警 | `sales_num=500, sale_day=35` |
| `[1, 2, 5]` | 无库存、无销量、库存待冲平 | `inventory_num=-10, sales_num=0`（这种情况理论上不存在） |
| `[3]` | 仅爆款 | `sales_num=500, sale_day=10`（销量大但周转快） |
| `[]` | 正常销售 | `inventory_num=100, sales_num=50, sale_day=10` |

### 3. 标签优先级

标签之间没有优先级关系，所有符合条件的标签都会被添加。例如：
- 如果 `inventory_num = 0` 且 `sales_num = 0`，会同时添加标签1和标签2
- 如果 `sales_num = 500` 且 `sale_day = 35`，会同时添加标签3和标签4

---

## 📝 示例说明

### 示例1：正常销售商品

**数据**：
- `inventory_num = 100`
- `sales_num = 50`
- `sale_day = 10`

**标签生成过程**：
1. `inventory_num = 100` ≠ 0 → 不添加标签1
2. `sales_num = 50` ≠ 0 → 不添加标签2
3. `sales_num = 50` ≤ 300 → 不添加标签3
4. 无爆款标签，`sale_day = 10` ≤ 15 → 不添加标签4
5. `inventory_num = 100` ≥ 0 → 不添加标签5

**结果**：`label = []`（无标签）→ 属于"正常销售"分类

---

### 示例2：爆款商品（周转快）

**数据**：
- `inventory_num = 200`
- `sales_num = 500`
- `sale_day = 10`

**标签生成过程**：
1. `inventory_num = 200` ≠ 0 → 不添加标签1
2. `sales_num = 500` ≠ 0 → 不添加标签2
3. `sales_num = 500` > 300 → **添加标签3**（爆款）
4. 有爆款标签，`sale_day = 10` ≤ 30 → 不添加标签4
5. `inventory_num = 200` ≥ 0 → 不添加标签5

**结果**：`label = [3]` → 属于"正常销售"分类（虽然有爆款标签，但没有异常标签）

---

### 示例3：爆款商品（需要预警）

**数据**：
- `inventory_num = 500`
- `sales_num = 500`
- `sale_day = 35`

**标签生成过程**：
1. `inventory_num = 500` ≠ 0 → 不添加标签1
2. `sales_num = 500` ≠ 0 → 不添加标签2
3. `sales_num = 500` > 300 → **添加标签3**（爆款）
4. 有爆款标签，`sale_day = 35` > 30 → **添加标签4**（在售天数预警）
5. `inventory_num = 500` ≥ 0 → 不添加标签5

**结果**：`label = [3, 4]` → 同时属于"正常销售"和"在售天数超15天"分类

---

### 示例4：有库存无销量

**数据**：
- `inventory_num = 100`
- `sales_num = 0`
- `sale_day = null`（因为销量为0，无法计算）

**标签生成过程**：
1. `inventory_num = 100` ≠ 0 → 不添加标签1
2. `sales_num = 0` → **添加标签2**（无销量）
3. `sales_num = 0` ≤ 300 → 不添加标签3
4. `sale_day = null` → 不添加标签4
5. `inventory_num = 100` ≥ 0 → 不添加标签5

**结果**：`label = [2]` → 属于"无销量"和"有库存无销量"分类

---

### 示例5：无库存无销量

**数据**：
- `inventory_num = 0`
- `sales_num = 0`
- `sale_day = null`

**标签生成过程**：
1. `inventory_num = 0` → **添加标签1**（无库存）
2. `sales_num = 0` → **添加标签2**（无销量）
3. `sales_num = 0` ≤ 300 → 不添加标签3
4. `sale_day = null` → 不添加标签4
5. `inventory_num = 0` ≥ 0 → 不添加标签5

**结果**：`label = [1, 2]` → 属于"无销量"分类，但不属于"有库存无销量"分类（因为包含标签1）

---

### 示例6：库存待冲平

**数据**：
- `inventory_num = -50`
- `sales_num = 10`
- `sale_day = 5`

**标签生成过程**：
1. `inventory_num = -50` ≠ 0 → 不添加标签1（注意：负数不算0）
2. `sales_num = 10` ≠ 0 → 不添加标签2
3. `sales_num = 10` ≤ 300 → 不添加标签3
4. 无爆款标签，`sale_day = 5` ≤ 15 → 不添加标签4
5. `inventory_num = -50` < 0 → **添加标签5**（库存待冲平）

**结果**：`label = [5]` → 属于"库存待冲平"分类

---

## 🔄 数据更新逻辑

### 导入数据时

1. 从Excel文件读取数据
2. 按SKU分组并计算：
   - `inventory_num` = SUM(库存数量) - SUM(待发货量) + SUM(在途量)
   - `sales_num` = SUM(最近7天销量)
   - `sale_day` = `inventory_num * 7 / sales_num`（如果 `sales_num > 0`）
3. 根据上述规则生成标签数组
4. 从 `per_charge` 表匹配 `charge` 字段
5. 保存到数据库（INSERT或UPDATE）

### 查询数据时

1. 从数据库读取数据
2. 将 `label` 字段从JSON字符串解析为数组
3. 根据筛选条件过滤数据
4. 使用标签映射表将数字标签转换为中文显示

---

## 📌 注意事项

1. **标签是动态生成的**：每次导入Excel数据时，会根据当前数据重新计算并生成标签
2. **标签可以组合**：一条记录可以同时拥有多个标签
3. **标签4的特殊性**：标签4的生成依赖于是否有标签3，这是唯一一个依赖其他标签的标签
4. **空标签处理**：如果记录不满足任何标签条件，`label` 字段为 `null` 或空数组 `[]`
5. **标签映射**：前端显示时，数字标签会自动转换为中文名称（通过 `lib/label-mapping.ts`）

---

## 🎯 使用场景

### 场景1：查看所有异常库存

点击"无销量"、"库存待冲平"等卡片，查看需要处理的异常库存。

### 场景2：查看正常销售商品

点击"正常销售"卡片，查看所有正常运营的商品。

### 场景3：查看需要预警的商品

点击"在售天数超15天"卡片，查看库存周转较慢、需要关注的商品。

### 场景4：查看有库存但无销量的商品

点击"有库存无销量"卡片，查看可能需要促销或清理的商品。

---

## 📚 相关文件

- **标签映射**：`lib/label-mapping.ts` - 标签数字到中文名称的映射
- **标签生成**：`app/actions/inventory.ts` - 导入数据时生成标签的逻辑
- **数据查询**：`lib/inventory-data.ts` - 根据标签筛选数据的逻辑
- **前端显示**：`components/slow-moving-inventory.tsx` - 标签的中文显示

---

## 🔧 修改标签规则

如果需要修改标签生成规则，请编辑 `app/actions/inventory.ts` 文件中的 `calculateInventoryData` 函数。

修改后，需要重新导入Excel数据才能生效（因为标签是在导入时生成的）。

