# Êµ∑Â§ñÁâ©ÊµÅÁÆ°ÁêÜÈ°µÈù¢ÊÄßËÉΩ‰ºòÂåñÁ¥ßÊÄ•ÊñπÊ°à

## üîç ÊÄßËÉΩÁì∂È¢àÂàÜÊûê

> **‚úÖ Êú¨ÂàÜÊûêÂü∫‰∫éÁúüÂÆû‰ª£Á†Å**Ôºö`lib/logistics-data.ts` Âíå `components/overseas-logistics.tsx`

### ÈóÆÈ¢ò 1Ôºö‰∏ªÊï∞ÊçÆÊü•ËØ¢ÊÖ¢

**ÁúüÂÆû‰ª£Á†Å‰ΩçÁΩÆ**Ôºö`lib/logistics-data.ts:79-157`

**Êü•ËØ¢Ê®°Âºè**Ôºö
```sql
SELECT * FROM post_searchs p
LEFT JOIN post_searchs t ON p.transfer_num = t.search_num
WHERE 1=1
ORDER BY p.ship_date DESC, p.id DESC  -- Á¨¨148Ë°å
```

**ÈóÆÈ¢ò**Ôºö
- ‚ùå `ORDER BY ship_date DESC, id DESC` Ê≤°ÊúâÁ¥¢ÂºïÊîØÊåÅ ‚Üí **ÂÖ®Ë°®Êâ´Êèè + ÊéíÂ∫è**
- ‚ùå `LEFT JOIN` ‰ΩøÁî® `transfer_num = search_num`ÔºåÂ¶ÇÊûú `transfer_num` Ê≤°ÊúâÁ¥¢Âºï ‚Üí **ÊÖ¢**
- ‚ùå **Ê≤°Êúâ LIMIT**Ôºå‰∏ÄÊ¨°ÊÄßÂä†ËΩΩÊâÄÊúâÊï∞ÊçÆ ‚Üí **ÂÜÖÂ≠òÂç†Áî®Â§ßÔºå‰º†ËæìÊÖ¢**

**ÂΩ±Âìç**ÔºöÊï∞ÊçÆÈáè 10 ‰∏áÊù°Êó∂ÔºåÊü•ËØ¢ÂèØËÉΩÈúÄË¶Å **5-30 Áßí**

### ÈóÆÈ¢ò 2ÔºöÁªüËÆ°Êü•ËØ¢ÊÖ¢

**ÁúüÂÆû‰ª£Á†Å‰ΩçÁΩÆ**Ôºö`lib/logistics-data.ts:169-242`

**Êü•ËØ¢Ê®°Âºè**Ôºà6 ‰∏™Áã¨Á´ãÊü•ËØ¢ÔºâÔºö
```sql
-- 1. ÈÄÄÂõû/ÂºÇÂ∏∏
SELECT COUNT(*) FROM post_searchs 
WHERE states IN ('Returned to Sender', ...) 
  AND ship_date >= ? AND ship_date <= ?

-- 2. Êú™‰∏äÁΩë
SELECT COUNT(*) FROM post_searchs 
WHERE states IN ('Not registered') 
  AND ship_date >= ? AND ship_date <= ?

-- 3. ËøêËæì‰∏≠
SELECT COUNT(*) FROM post_searchs 
WHERE states NOT IN ('Final delivery', ...) 
  AND ship_date >= ? AND ship_date <= ?

-- 4. ‰∏äÁΩëÂºÇÂ∏∏
SELECT COUNT(*) FROM post_searchs 
WHERE states IN ('Not registered', 'Êú™‰∏äÁΩë')
  AND ship_date IS NOT NULL
  AND EXTRACT(DAY FROM (CURRENT_DATE - ship_date))::INTEGER >= 3

-- 5. Êú™Êü•ËØ¢
SELECT COUNT(*) FROM post_searchs 
WHERE (states IS NULL OR states = '')

-- 6. ÊàêÂäüÁ≠æÊî∂
SELECT COUNT(*) FROM post_searchs 
WHERE states = 'Final delivery'
```

**ÈóÆÈ¢ò**Ôºö
- ‚ùå `states IN (...)` Ê≤°ÊúâÂêàÈÄÇÁöÑÁ¥¢Âºï ‚Üí **ÂÖ®Ë°®Êâ´Êèè**
- ‚ùå `ship_date >= ... AND ship_date <= ...` Ê≤°ÊúâÂ§çÂêàÁ¥¢Âºï ‚Üí **ÊÖ¢**
- ‚ùå 6 ‰∏™Áã¨Á´ãÊü•ËØ¢ÔºåÊØè‰∏™ÈÉΩÂèØËÉΩÂÖ®Ë°®Êâ´Êèè ‚Üí **ÊÄªËÄóÊó∂ = 6 √ó ÂçïÊ¨°Êü•ËØ¢Êó∂Èó¥**

**ÂΩ±Âìç**ÔºöÊï∞ÊçÆÈáè 10 ‰∏áÊù°Êó∂ÔºåÁªüËÆ°Êü•ËØ¢ÂèØËÉΩÈúÄË¶Å **3-15 Áßí**

### ÈóÆÈ¢ò 3ÔºöLEFT JOIN ÊÖ¢

**ÁúüÂÆû‰ª£Á†Å‰ΩçÁΩÆ**Ôºö`lib/logistics-data.ts:71-77`

**Êü•ËØ¢Ê®°Âºè**Ôºö
```sql
LEFT JOIN post_searchs t ON p.transfer_num = t.search_num  -- Á¨¨74Ë°å
```

**ÈóÆÈ¢ò**Ôºö
- ‚ùå `transfer_num` Â≠óÊÆµÂèØËÉΩÊ≤°ÊúâÁ¥¢Âºï ‚Üí **JOIN ÊÖ¢**
- ‚ùå Âç≥‰ΩøÊúâÁ¥¢ÂºïÔºåJOIN Â§ßË°®‰πü‰ºöÊÖ¢

**ÂΩ±Âìç**ÔºöÊï∞ÊçÆÈáè 10 ‰∏áÊù°Êó∂ÔºåJOIN ÂèØËÉΩÈúÄË¶Å **1-5 Áßí**

## üöÄ ‰ºòÂåñÊñπÊ°à

### ÊñπÊ°à 1ÔºöÂàõÂª∫Á¥¢ÂºïÔºàÊúÄÈáçË¶ÅÔºÅÁ´ãÂç≥ÊâßË°åÔºâ

**ÊâßË°å `sql/postgresql/create_indexes_only.sql` ‰∏≠ÁöÑÁ¥¢Âºï 18-22**Ôºö

```sql
-- 1. ÊéíÂ∫èÁ¥¢ÂºïÔºàÊúÄÈáçË¶ÅÔºÅÔºâ
CREATE INDEX CONCURRENTLY IF NOT EXISTS idx_post_searchs_ship_date_id 
ON post_searchs(ship_date DESC, id DESC);

-- 2. Áä∂ÊÄÅ+Êó•ÊúüÂ§çÂêàÁ¥¢Âºï
CREATE INDEX CONCURRENTLY IF NOT EXISTS idx_post_searchs_states_ship_date 
ON post_searchs(states, ship_date) WHERE states IS NOT NULL;

-- 3. Êó•Êúü+Áä∂ÊÄÅÂ§çÂêàÁ¥¢Âºï
CREATE INDEX CONCURRENTLY IF NOT EXISTS idx_post_searchs_ship_date_states 
ON post_searchs(ship_date, states) WHERE states IS NOT NULL;

-- 4. Êõ¥Êñ∞Êó∂Èó¥Á¥¢Âºï
CREATE INDEX CONCURRENTLY IF NOT EXISTS idx_post_searchs_updated_at 
ON post_searchs(updated_at DESC);

-- 5. Áä∂ÊÄÅ+Êó•Êúü+IDÂ§çÂêàÁ¥¢Âºï
CREATE INDEX CONCURRENTLY IF NOT EXISTS idx_post_searchs_states_ship_date_id 
ON post_searchs(states, ship_date DESC, id DESC) WHERE states IS NOT NULL;
```

**È¢ÑÊúüÊïàÊûú**Ôºö
- ‚úÖ ‰∏ªÊü•ËØ¢ÊéíÂ∫èÔºö‰ªé **5-30 Áßí** ‚Üí **0.1-0.5 Áßí**ÔºàÊèêÂçá **10-100 ÂÄç**Ôºâ
- ‚úÖ ÁªüËÆ°Êü•ËØ¢Ôºö‰ªé **3-15 Áßí** ‚Üí **0.1-0.3 Áßí**ÔºàÊèêÂçá **10-50 ÂÄç**Ôºâ

### ÊñπÊ°à 2ÔºöÊ∑ªÂä†ÂàÜÈ°µÔºàÂáèÂ∞ëÊï∞ÊçÆ‰º†ËæìÔºâ

**ÁúüÂÆû‰ª£Á†Å‰ΩçÁΩÆ**Ôºö`lib/logistics-data.ts:35-158`ÔºàÂΩìÂâçÊ≤°ÊúâÂàÜÈ°µÔºâ

**ÈóÆÈ¢ò**ÔºöÁ¨¨156Ë°åÁõ¥Êé•ËøîÂõûÊâÄÊúâÁªìÊûúÔºåÊ≤°Êúâ `LIMIT`

**‰øÆÊîπ `lib/logistics-data.ts`**ÔºåÊ∑ªÂä† `LIMIT` Âíå `OFFSET`Ôºö

```typescript
export async function getLogisticsData(
  searchNum?: string,
  statusFilter?: 'in_transit' | 'returned' | 'not_online' | 'online_abnormal' | 'not_queried' | 'delivered',
  dateFrom?: string,
  dateTo?: string,
  page: number = 1,  // Êñ∞Â¢û
  pageSize: number = 50  // Êñ∞Â¢û
): Promise<{ data: LogisticsRecord[], total: number }> {
  // ... Áé∞Êúâ‰ª£Á†Å ...
  
  sql += ' ORDER BY p.ship_date DESC, p.id DESC'
  sql += ` LIMIT $${paramIndex} OFFSET $${paramIndex + 1}`
  params.push(pageSize, (page - 1) * pageSize)
  
  // Ëé∑ÂèñÊÄªÊï∞
  const countSql = sql.replace(/SELECT.*FROM/, 'SELECT COUNT(*) as total FROM')
    .replace(/ORDER BY.*/, '')
    .replace(/LIMIT.*/, '')
  const totalResult = await query<{ total: number }>(countSql, params.slice(0, -2))
  const total = Number(totalResult[0]?.total) || 0
  
  const results = await query<LogisticsRecord>(sql, params)
  return { data: results, total }
}
```

**È¢ÑÊúüÊïàÊûú**Ôºö
- ‚úÖ Êï∞ÊçÆ‰º†ËæìÈáèÔºö‰ªé **ÂÖ®ÈÉ®Êï∞ÊçÆ** ‚Üí **ÊØèÈ°µ 50 Êù°**ÔºàÂáèÂ∞ë **99%+**Ôºâ
- ‚úÖ È¶ñÊ¨°Âä†ËΩΩÊó∂Èó¥Ôºö‰ªé **5-30 Áßí** ‚Üí **0.1-0.5 Áßí**ÔºàÊèêÂçá **10-100 ÂÄç**Ôºâ

### ÊñπÊ°à 3Ôºö‰ºòÂåñ LEFT JOINÔºàÂèØÈÄâÔºâ

**Â¶ÇÊûú `transfer_num` Â≠óÊÆµ‰ΩøÁî®È¢ëÁéá‰∏çÈ´òÔºåÂèØ‰ª•ËÄÉËôë**Ôºö

1. **Âª∂ËøüÂä†ËΩΩ**Ôºö‰∏çÂú®‰∏ªÊü•ËØ¢‰∏≠ JOINÔºåËÄåÊòØÂú®ÈúÄË¶ÅÊó∂ÂçïÁã¨Êü•ËØ¢
2. **ÁºìÂ≠òÁªìÊûú**ÔºöÂ∞Ü JOIN ÁªìÊûúÁºìÂ≠òÂà∞ÂâçÁ´Ø
3. **ÂºÇÊ≠•Âä†ËΩΩ**Ôºö‰∏ªÊï∞ÊçÆÂä†ËΩΩÂêéÔºåÂºÇÊ≠•Âä†ËΩΩËΩ¨ÂçïÂè∑‰ø°ÊÅØ

### ÊñπÊ°à 4Ôºö‰ºòÂåñÁªüËÆ°Êü•ËØ¢ÔºàÂêàÂπ∂Êü•ËØ¢Ôºâ

**ÁúüÂÆû‰ª£Á†Å‰ΩçÁΩÆ**Ôºö`lib/logistics-data.ts:188-232`ÔºàÂΩìÂâçÊòØ6‰∏™Áã¨Á´ãÊü•ËØ¢Ôºâ

**Â∞Ü 6 ‰∏™Áã¨Á´ãÊü•ËØ¢ÂêàÂπ∂‰∏∫ 1 ‰∏™Êü•ËØ¢**Ôºö

```sql
SELECT 
  COUNT(*) FILTER (WHERE states IN ('Returned to Sender', ...)) as returned,
  COUNT(*) FILTER (WHERE states IN ('Not registered')) as not_online,
  COUNT(*) FILTER (WHERE states NOT IN ('Final delivery', ...)) as in_transit,
  COUNT(*) FILTER (WHERE states IN ('Not registered', 'Êú™‰∏äÁΩë') 
    AND ship_date IS NOT NULL 
    AND EXTRACT(DAY FROM (CURRENT_DATE - ship_date))::INTEGER >= 3) as online_abnormal,
  COUNT(*) FILTER (WHERE states IS NULL OR states = '') as not_queried,
  COUNT(*) FILTER (WHERE states = 'Final delivery') as delivered
FROM post_searchs
WHERE ship_date >= ? AND ship_date <= ?
```

**È¢ÑÊúüÊïàÊûú**Ôºö
- ‚úÖ Êü•ËØ¢Ê¨°Êï∞Ôºö‰ªé **6 Ê¨°** ‚Üí **1 Ê¨°**ÔºàÂáèÂ∞ë **83%**Ôºâ
- ‚úÖ ÊÄªËÄóÊó∂Ôºö‰ªé **3-15 Áßí** ‚Üí **0.1-0.3 Áßí**ÔºàÊèêÂçá **10-50 ÂÄç**Ôºâ

## üìä ‰ºòÂåñ‰ºòÂÖàÁ∫ß

### üî¥ Á¥ßÊÄ•ÔºàÁ´ãÂç≥ÊâßË°åÔºâ

1. **ÂàõÂª∫Á¥¢Âºï**ÔºàÊñπÊ°à 1Ôºâ
   - ÊâßË°åÊó∂Èó¥Ôºö5-30 ÂàÜÈíüÔºàÊ†πÊçÆÊï∞ÊçÆÈáèÔºâ
   - ÊÄßËÉΩÊèêÂçáÔºö**10-100 ÂÄç**
   - È£éÈô©Ôºö‰ΩéÔºà‰ΩøÁî® CONCURRENTLYÔºå‰∏çÈîÅË°®Ôºâ

### üü° ÈáçË¶ÅÔºàÂ∞ΩÂø´ÊâßË°åÔºâ

2. **Ê∑ªÂä†ÂàÜÈ°µ**ÔºàÊñπÊ°à 2Ôºâ
   - ÊâßË°åÊó∂Èó¥Ôºö10-30 ÂàÜÈíüÔºà‰øÆÊîπ‰ª£Á†ÅÔºâ
   - ÊÄßËÉΩÊèêÂçáÔºö**10-100 ÂÄç**ÔºàÈ¶ñÊ¨°Âä†ËΩΩÔºâ
   - È£éÈô©Ôºö‰ΩéÔºàÂêëÂêéÂÖºÂÆπÔºâ

3. **‰ºòÂåñÁªüËÆ°Êü•ËØ¢**ÔºàÊñπÊ°à 4Ôºâ
   - ÊâßË°åÊó∂Èó¥Ôºö10-20 ÂàÜÈíüÔºà‰øÆÊîπ‰ª£Á†ÅÔºâ
   - ÊÄßËÉΩÊèêÂçáÔºö**5-10 ÂÄç**ÔºàÁªüËÆ°Êü•ËØ¢Ôºâ
   - È£éÈô©Ôºö‰ΩéÔºàÈÄªËæë‰∏çÂèòÔºâ

### üü¢ ÂèØÈÄâÔºàÂêéÁª≠‰ºòÂåñÔºâ

4. **‰ºòÂåñ LEFT JOIN**ÔºàÊñπÊ°à 3Ôºâ
   - ÊâßË°åÊó∂Èó¥Ôºö30-60 ÂàÜÈíüÔºàÈúÄË¶ÅÈáçÊûÑÔºâ
   - ÊÄßËÉΩÊèêÂçáÔºö**2-5 ÂÄç**
   - È£éÈô©Ôºö‰∏≠ÔºàÈúÄË¶ÅÊµãËØïÔºâ

## üéØ È¢ÑÊúüÊÄª‰ΩìÊïàÊûú

| ‰ºòÂåñÈ°π | ‰ºòÂåñÂâç | ‰ºòÂåñÂêé | ÊèêÂçáÂÄçÊï∞ |
|--------|--------|--------|---------|
| ‰∏ªÊï∞ÊçÆÊü•ËØ¢ | 5-30 Áßí | 0.1-0.5 Áßí | **10-100 ÂÄç** |
| ÁªüËÆ°Êü•ËØ¢ | 3-15 Áßí | 0.1-0.3 Áßí | **10-50 ÂÄç** |
| ÊÄªÂä†ËΩΩÊó∂Èó¥ | **8-45 Áßí** | **0.2-0.8 Áßí** | **10-100 ÂÄç** |

## üìù ÊâßË°åÊ≠•È™§

### Ê≠•È™§ 1ÔºöÂàõÂª∫Á¥¢ÂºïÔºàÁ´ãÂç≥ÊâßË°åÔºâ

1. ÊâìÂºÄÊï∞ÊçÆÂ∫ìÁÆ°ÁêÜÂ∑•ÂÖ∑
2. ÊâßË°å `sql/postgresql/create_indexes_only.sql` ‰∏≠ÁöÑÁ¥¢Âºï 18-22
3. Á≠âÂæÖÁ¥¢ÂºïÂàõÂª∫ÂÆåÊàêÔºà5-30 ÂàÜÈíüÔºâ
4. ‰ΩøÁî® `sql/postgresql/check_index_status.sql` Ê£ÄÊü•Á¥¢ÂºïÁä∂ÊÄÅ

### Ê≠•È™§ 2ÔºöÈ™åËØÅÊïàÊûú

1. Âà∑Êñ∞Êµ∑Â§ñÁâ©ÊµÅÁÆ°ÁêÜÈ°µÈù¢
2. ËßÇÂØüÂä†ËΩΩÊó∂Èó¥
3. Â¶ÇÊûú‰ªçÁÑ∂ÊÖ¢ÔºåÁªßÁª≠ÊâßË°åÊ≠•È™§ 3

### Ê≠•È™§ 3ÔºöÊ∑ªÂä†ÂàÜÈ°µÔºàÂ¶ÇÊûúÊ≠•È™§ 1 ‰∏çÂ§üÔºâ

1. ‰øÆÊîπ `lib/logistics-data.ts` Ê∑ªÂä†ÂàÜÈ°µÂèÇÊï∞
2. ‰øÆÊîπ `components/overseas-logistics.tsx` ‰ΩøÁî®ÂàÜÈ°µ
3. ÊµãËØïÂàÜÈ°µÂäüËÉΩ

### Ê≠•È™§ 4Ôºö‰ºòÂåñÁªüËÆ°Êü•ËØ¢ÔºàÂèØÈÄâÔºâ

1. ‰øÆÊîπ `lib/logistics-data.ts` ÂêàÂπ∂ÁªüËÆ°Êü•ËØ¢
2. ÊµãËØïÁªüËÆ°ÂäüËÉΩ

## ‚ö†Ô∏è Ê≥®ÊÑè‰∫ãÈ°π

1. **Á¥¢ÂºïÂàõÂª∫Êó∂Èó¥**Ôºö‰ΩøÁî® `CONCURRENTLY` ‰∏ç‰ºöÈîÅË°®Ôºå‰ΩÜÂàõÂª∫Êó∂Èó¥ËæÉÈïø
2. **Á¥¢ÂºïÂ§ßÂ∞è**ÔºöÂ§çÂêàÁ¥¢Âºï‰ºöÂç†Áî®Êõ¥Â§öÂ≠òÂÇ®Á©∫Èó¥ÔºàÈÄöÂ∏∏ 10-50MBÔºâ
3. **Êü•ËØ¢‰ºòÂåñÂô®**ÔºöPostgreSQL ‰ºöËá™Âä®ÈÄâÊã©ÊúÄ‰Ω≥Á¥¢ÂºïÔºåÊó†ÈúÄÊâãÂä®ÊåáÂÆö
4. **ÂÆöÊúüÁª¥Êä§**ÔºöÊâßË°å `VACUUM ANALYZE post_searchs` Êõ¥Êñ∞ÁªüËÆ°‰ø°ÊÅØ

## üîß Âø´ÈÄüÊ£ÄÊü•

ÊâßË°å‰ª•‰∏ã SQL Ê£ÄÊü•Á¥¢ÂºïÊòØÂê¶Â∑≤ÂàõÂª∫Ôºö

```sql
SELECT indexname 
FROM pg_indexes 
WHERE tablename = 'post_searchs' 
  AND indexname LIKE 'idx_post_searchs%'
ORDER BY indexname;
```

**È¢ÑÊúüÁªìÊûú**ÔºöÂ∫îËØ•ÁúãÂà∞ 5 ‰∏™Á¥¢ÂºïÔºö
- idx_post_searchs_ship_date_id
- idx_post_searchs_states_ship_date
- idx_post_searchs_ship_date_states
- idx_post_searchs_updated_at
- idx_post_searchs_states_ship_date_id

