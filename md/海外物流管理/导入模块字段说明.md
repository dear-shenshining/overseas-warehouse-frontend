# 海外物流管理模块 - 导入功能字段说明

## 一、导入字段说明

### 1.1 Excel文件列名映射

导入模块从Excel文件中读取以下列（定义在 `lib/logistics-import.ts` 的 `EXCEL_COLUMNS` 常量中）：

| Excel列名 | 数据库字段 | 是否必需 | 数据类型 | 说明 |
|---------|-----------|---------|---------|------|
| **发货单号** | `search_num` | ✅ **必需** | VARCHAR(255) | 唯一标识，作为主键冲突判断依据 |
| **发货日期** | `ship_date` | 可选 | TIMESTAMP | 支持Excel日期序列号和标准日期格式 |
| **发货渠道** | `channel` | 可选 | VARCHAR(255) | 发货渠道名称 |
| **订单号** | `order_num` | 可选 | VARCHAR(255) | 订单号（需要表中有该字段） |
| **转单号** | `transfer_num` | 可选 | VARCHAR(255) | 转单号，**只能是数字**（需要表中有该字段） |
| **备注** | `notes` | 可选 | TEXT | 备注信息（需要表中有该字段） |

### 1.2 字段处理逻辑

#### 发货单号（search_num）
- **必需字段**：如果为空或不存在，该行数据会被跳过
- **类型转换**：
  - 数字类型：自动转换为字符串，去除小数点（如 `123.0` → `"123"`）
  - 字符串类型：去除首尾空格
- **唯一性**：数据库表 `post_searchs` 中 `search_num` 字段有 `UNIQUE` 约束

```typescript:lib/logistics-import.ts
// 处理发货单号
if (shippingNum == null || shippingNum === '') {
  continue  // 跳过空值
}
if (typeof shippingNum === 'number') {
  if (Number.isInteger(shippingNum)) {
    shippingNum = String(shippingNum)
  } else {
    shippingNum = String(Math.floor(shippingNum))
  }
} else {
  shippingNum = String(shippingNum).trim()
  // 移除 .0 后缀
  if (shippingNum.endsWith('.0')) {
    shippingNum = shippingNum.slice(0, -2)
  }
}
```

#### 发货日期（ship_date）
- **支持格式**：
  - Excel日期序列号（数字）
  - JavaScript Date对象
  - 标准日期字符串
- **转换逻辑**：统一转换为 `YYYY-MM-DD` 格式

```typescript:lib/logistics-import.ts
// 处理发货日期
if (typeof dateValue === 'number') {
  // Excel日期从1900-01-01开始，但实际是1899-12-30
  const excelEpoch = new Date(1899, 11, 30)
  const days = Math.floor(dateValue)
  const date = new Date(excelEpoch.getTime() + days * 24 * 60 * 60 * 1000)
  shipDate = date.toISOString().split('T')[0]
}
```

#### 转单号（transfer_num）
- **特殊验证**：**只能是纯数字**
- **验证规则**：使用正则表达式 `/^\d+$/` 验证
- **处理逻辑**：如果不是纯数字，则设为 `null`

```typescript:lib/logistics-import.ts
// 处理转单号（只能是数字）
if (hasTransferNum && row[EXCEL_COLUMNS.TRANSFER_NUM] != null) {
  const transferNumStr = String(transferNumValue).trim()
  // 验证转单号只能是数字
  if (transferNumStr && /^\d+$/.test(transferNumStr)) {
    transferNum = transferNumStr
  } else if (transferNumStr) {
    // 如果不是纯数字，设为null
    transferNum = null
  }
}
```

#### 订单号和备注
- **订单号**：支持数字和字符串，自动转换为字符串
- **备注**：支持任意文本内容

### 1.3 动态字段检测

导入模块会动态检测数据库中是否存在新字段（`order_num`、`transfer_num`、`notes`），如果字段不存在，则不会尝试插入这些字段：

```typescript:lib/logistics-import.ts
// 检查新字段是否存在（只检查一次，提高性能）
const { checkLogisticsNewFields } = await import('./check-table-structure')
const { hasOrderNum, hasTransferNum, hasNotes } = await checkLogisticsNewFields()

// 构建基础字段列表
const baseFields = ['search_num', 'ship_date', 'channel']
const allFields = [...baseFields]
if (hasOrderNum) allFields.push('order_num')
if (hasTransferNum) allFields.push('transfer_num')
if (hasNotes) allFields.push('notes')
```

## 二、增量同步实现分析

### 2.1 当前实现方式

**结论：✅ 已实现智能增量同步**

当前导入逻辑实现了智能更新机制：

1. **新记录**：如果 `search_num` 不存在，则插入新记录
2. **已存在记录**：根据字段变化情况智能更新：
   - **转单号不一致**：更新转单号，添加转运日期（当前日期），清空状态
   - **备注不一致**：更新备注内容
   - **无变化**：跳过该记录

### 2.2 更新规则详解

#### 规则1：转单号不一致时更新

**触发条件**：
- 货运单号（`search_num`）已存在
- 转单号（`transfer_num`）与数据库中的值不一致
- Excel中的转单号不为空

**更新操作**：
1. 更新 `transfer_num` 为新值
2. 设置 `transfer_date` 为当前日期（如果字段存在）
3. 清空 `states` 字段（设为 `null`）

```typescript:lib/logistics-import.ts
// 检查转单号是否不一致
if (hasTransferNum) {
  const existingTransferNum = existingRecord.transfer_num || null
  const newTransferNum = item.transfer_num || null
  
  const transferNumChanged = 
    (existingTransferNum !== newTransferNum) &&
    !(existingTransferNum === null && newTransferNum === null) &&
    !(existingTransferNum === '' && newTransferNum === null) &&
    !(existingTransferNum === null && newTransferNum === '')
  
  if (transferNumChanged && newTransferNum !== null) {
    // 更新转单号、添加转运日期、清空状态
    updateFields.push(`transfer_num = $${paramIndex}`)
    updateValues.push(newTransferNum)
    
    if (hasTransferDate) {
      updateFields.push(`transfer_date = $${paramIndex}`)
      updateValues.push(new Date().toISOString().split('T')[0])
    }
    
    updateFields.push(`states = $${paramIndex}`)
    updateValues.push(null)
  }
}
```

#### 规则2：备注不一致时更新

**触发条件**：
- 货运单号（`search_num`）已存在
- 备注（`notes`）与数据库中的值不一致

**更新操作**：
1. 更新 `notes` 为新值

```typescript:lib/logistics-import.ts
// 检查备注是否不一致
if (hasNotes) {
  const existingNotes = existingRecord.notes || null
  const newNotes = item.notes || null
  
  const notesChanged = 
    (existingNotes !== newNotes) &&
    !(existingNotes === null && newNotes === null) &&
    !(existingNotes === '' && newNotes === null) &&
    !(existingNotes === null && newNotes === '')
  
  if (notesChanged) {
    // 更新备注
    updateFields.push(`notes = $${paramIndex}`)
    updateValues.push(newNotes)
  }
}
```

### 2.3 导入统计

导入完成后会返回以下统计信息：

```typescript
{
  success: boolean
  message?: string
  stats?: {
    total: number      // 总记录数
    inserted: number   // 新增记录数
    updated: number    // 更新记录数（转单号或备注有变化）
    skipped: number   // 跳过记录数（无变化或插入失败）
  }
}
```

### 2.4 导入结果示例

```
导入完成：总计 100 条，新增 30 条，更新 15 条，跳过 55 条
```

### 2.5 转运日期字段

**新增字段**：`transfer_date`（转运日期）

- **类型**：`TIMESTAMP`
- **用途**：记录转单号更新的日期
- **设置时机**：当转单号发生变化时，自动设置为当前日期
- **SQL文件**：`sql/postgresql/add_transfer_date_field.sql`

```sql
ALTER TABLE post_searchs 
ADD COLUMN IF NOT EXISTS transfer_date TIMESTAMP DEFAULT NULL;

COMMENT ON COLUMN post_searchs.transfer_date IS '转运日期（转单号更新时的日期）';
```

## 三、数据库表结构

### 3.1 基础表结构

```sql:sql/postgresql/create_post_searchs_table.sql
CREATE TABLE IF NOT EXISTS post_searchs (
  id SERIAL PRIMARY KEY,
  search_num VARCHAR(255) NOT NULL UNIQUE,  -- 唯一约束，用于冲突检测
  states VARCHAR(255) DEFAULT NULL,
  ship_date TIMESTAMP DEFAULT NULL,
  channel VARCHAR(255) DEFAULT NULL,
  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);
```

### 3.2 扩展字段（可选）

```sql:sql/postgresql/add_logistics_fields.sql
ALTER TABLE post_searchs 
ADD COLUMN IF NOT EXISTS transfer_num VARCHAR(255) DEFAULT NULL;

ALTER TABLE post_searchs 
ADD COLUMN IF NOT EXISTS order_num VARCHAR(255) DEFAULT NULL;

ALTER TABLE post_searchs 
ADD COLUMN IF NOT EXISTS notes TEXT DEFAULT NULL;
```

## 四、实现细节说明

### 4.1 字段比较逻辑

导入模块会智能比较已存在记录和Excel中的字段值，判断是否需要更新：

#### 转单号比较
- 考虑 `null` 和空字符串的等价性
- 只有当值真正不同时才触发更新
- 新值为 `null` 时不更新（避免清空已有转单号）

#### 备注比较
- 考虑 `null` 和空字符串的等价性
- 支持从空到有值、从有值到空、值变更三种情况

### 4.2 批量查询优化

为了提高性能，导入模块会：
1. 一次性查询所有已存在的记录（包括转单号和备注）
2. 构建内存映射表，实现 O(1) 查找
3. 避免逐条查询数据库

```typescript:lib/logistics-import.ts
// 批量查询已存在的记录
const existingResult = await query<{ 
  search_num: string
  transfer_num?: string | null
  notes?: string | null
}>(
  `SELECT search_num, transfer_num, notes FROM post_searchs WHERE search_num = ANY($1::text[])`,
  [allSearchNums]
)

// 构建映射表
const existingMap = new Map<string, { transfer_num?: string | null, notes?: string | null }>()
for (const record of existingResult) {
  existingMap.set(record.search_num, {
    transfer_num: record.transfer_num,
    notes: record.notes,
  })
}
```

### 4.3 状态清空说明

当转单号发生变化时，系统会自动清空 `states` 字段，原因：
- 转单号变更意味着物流信息可能发生变化
- 清空状态后，爬虫会重新查询新的转单号状态
- 确保状态信息的准确性

## 五、总结

### 5.1 导入字段总结

| 字段 | Excel列名 | 数据库字段 | 必需 | 特殊处理 |
|-----|---------|-----------|------|---------|
| 发货单号 | 发货单号 | `search_num` | ✅ | 数字转字符串，去除.0 |
| 发货日期 | 发货日期 | `ship_date` | ❌ | Excel日期序列号转换 |
| 发货渠道 | 发货渠道 | `channel` | ❌ | 字符串trim |
| 订单号 | 订单号 | `order_num` | ❌ | 动态检测字段存在 |
| 转单号 | 转单号 | `transfer_num` | ❌ | **只能数字**，动态检测 |
| 备注 | 备注 | `notes` | ❌ | 动态检测字段存在 |

### 5.2 增量同步总结

- **当前状态**：✅ **已实现智能增量同步**
- **行为**：
  - 新记录：直接插入
  - 已存在记录：根据字段变化智能更新
    - 转单号不一致 → 更新转单号、添加转运日期、清空状态
    - 备注不一致 → 更新备注
    - 无变化 → 跳过
- **冲突处理**：
  - 新记录：使用 `ON CONFLICT (search_num) DO NOTHING` 插入
  - 已存在记录：使用 `UPDATE` 语句更新变化字段
- **统计信息**：`updated` 字段记录实际更新的记录数

### 5.3 相关代码文件

- **导入逻辑**：`lib/logistics-import.ts`
- **字段检测**：`lib/check-table-structure.ts`
- **服务端操作**：`app/actions/logistics.ts`
- **前端组件**：`components/overseas-logistics.tsx`
- **表结构SQL**：`sql/postgresql/create_post_searchs_table.sql`
- **扩展字段SQL**：`sql/postgresql/add_logistics_fields.sql`
- **转运日期字段SQL**：`sql/postgresql/add_transfer_date_field.sql`

## 六、使用说明

### 6.1 首次使用

1. **执行SQL脚本**（如果尚未执行）：
   ```sql
   -- 执行基础表结构
   \i sql/postgresql/create_post_searchs_table.sql
   
   -- 执行扩展字段
   \i sql/postgresql/add_logistics_fields.sql
   
   -- 执行转运日期字段
   \i sql/postgresql/add_transfer_date_field.sql
   ```

2. **准备Excel文件**：
   - 必须包含"发货单号"列
   - 可选包含：发货日期、发货渠道、订单号、转单号、备注

3. **导入数据**：
   - 在前端页面点击"导入数据"按钮
   - 选择Excel文件
   - 等待导入完成

### 6.2 增量更新场景

#### 场景1：转单号变更
- **Excel中**：发货单号 `12345`，转单号 `67890`
- **数据库中**：发货单号 `12345`，转单号 `11111`
- **结果**：
  - 转单号更新为 `67890`
  - 转运日期设置为当前日期
  - 状态清空（等待重新查询）

#### 场景2：备注变更
- **Excel中**：发货单号 `12345`，备注 `新备注`
- **数据库中**：发货单号 `12345`，备注 `旧备注`
- **结果**：备注更新为 `新备注`

#### 场景3：无变化
- **Excel中**：发货单号 `12345`，转单号 `11111`，备注 `旧备注`
- **数据库中**：发货单号 `12345`，转单号 `11111`，备注 `旧备注`
- **结果**：跳过该记录（不执行任何操作）

