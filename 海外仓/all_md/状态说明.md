# 海外仓爬虫系统状态说明

## 📋 概述

海外仓爬虫系统会根据日本邮政网站的响应自动更新单号状态。系统支持多种状态类型，每种状态都有特定的含义和处理逻辑。

## 🎯 支持的状态类型

### 1. **Not registered** （未注册）
- **触发条件**：HTML响应中包含 "Your item was not found. Confirm your item number and ask at your local office."
- **含义**：该单号在日本邮政系统中未注册或不存在
- **处理方式**：标记为未注册，但**不会跳过**，系统会继续定期查询（单号可能在后续时间被注册）
- **重要说明**：与其他最终状态不同，Not registered状态允许重复查询
- **示例场景**：单号输入错误、无效单号、新单号等待注册等

### 2. **Final delivery** （最终配送）
- **触发条件**：最后一条追踪记录的 `shipping_track_record` 字段包含 "Final delivery"
- **含义**：包裹已完成最终配送，成功送达收件人
- **处理方式**：标记为已完成，后续查询会跳过
- **示例场景**：正常完成的配送流程

### 3. **Returned to sender** （退货给寄件人）
- **触发条件**：最后一条追踪记录的 `shipping_track_record` 字段包含 "Returned to sender"
- **含义**：包裹因各种原因被退回给寄件人
- **处理方式**：标记为退货，后续查询会跳过
- **示例场景**：收件地址错误、拒收、超时等情况

### 4. **NULL/空状态** （待处理）
- **触发条件**：新导入的单号或尚未查询过的单号
- **含义**：等待系统进行首次查询
- **处理方式**：系统会优先处理这些单号
- **示例场景**：刚导入的Excel数据

## 🔄 状态处理流程

### 查询流程
```
开始查询单号
    ↓
检查HTML响应
    ↓
├── 包含 "Your item was not found" → 设置 "Not registered"
    ↓
解析追踪记录
    ↓
├── 最后一条包含 "Final delivery" → 设置 "Final delivery"
└── 其他情况 → 设置最后一条记录的shipping_track_record值
```

### 过滤逻辑
系统在读取待查询单号时，会自动过滤以下状态：
- `Final delivery` （已完成）
- `Returned to sender` （已退货）

**注意**：`Not registered` 状态不会被跳过，系统会继续查询此类单号，因为单号可能在后续时间被注册。


只有状态为 `NULL` 或不在上述列表中的单号会被纳入查询队列。

## 📊 数据库表结构

### Post_searchs 表字段说明

```sql
CREATE TABLE Post_searchs (
    id INT AUTO_INCREMENT PRIMARY KEY,           -- 自增主键
    search_num VARCHAR(64) NOT NULL UNIQUE,       -- 追踪号（唯一索引）
    states VARCHAR(64) NULL,                      -- 状态字段
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP,-- 创建时间
    updated_at DATETIME DEFAULT CURRENT_TIMESTAMP -- 更新时间
    ON UPDATE CURRENT_TIMESTAMP
);
```

**字段含义：**
- `search_num`: 日本邮政追踪号
- `states`: 当前状态（上述5种状态之一）
- `created_at`: 单号首次导入时间
- `updated_at`: 状态最后更新时间

## 🎯 业务意义

### 对运营的帮助
1. **状态跟踪**：清晰了解每个单号的处理状态
2. **效率提升**：避免重复查询已完成的单号
3. **问题识别**：快速识别无效单号和异常情况
4. **数据统计**：为后续分析提供基础数据

### 状态分布统计
可以通过以下SQL查询各状态的单号数量：

```sql
SELECT
    states,
    COUNT(*) as count,
    ROUND(COUNT(*) * 100.0 / (SELECT COUNT(*) FROM Post_searchs), 2) as percentage
FROM Post_searchs
GROUP BY states
ORDER BY count DESC;
```

## ⚠️ 注意事项

1. **状态不可逆**：一旦设置为最终状态（Final delivery、Returned to sender），后续查询会跳过
2. **实时更新**：状态会在每次查询后实时更新
3. **兼容性**：系统同时支持新旧格式的状态名称
4. **异常处理**：网络错误或解析失败不会影响状态更新

## 🔧 维护说明

### 添加新状态
如需添加新的状态类型，需要在以下位置同时更新：

1. **状态检查逻辑**：`japan_post_crawler.py` 中的状态判断条件
2. **过滤列表**：`fetch_pending_search_numbers()` 和第一次循环的状态过滤
3. **数据库更新**：确保新状态能正确写入数据库
4. **文档更新**：更新本说明文档

### 状态优先级
状态更新的优先级从高到低：
1. Not registered（最高优先级，直接错误）
2. Final delivery
3. Returned to sender
4. nofound（最低优先级）

---

**文档版本**：v1.0
**最后更新**：2024年12月27日
**维护人员**：系统管理员
