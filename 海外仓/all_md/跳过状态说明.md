# 爬虫跳过状态说明

## 📋 概述

海外仓爬虫系统在运行时会智能跳过已完成查询的单号，以提高处理效率和避免重复查询。本文档详细说明系统会跳过哪些状态以及跳过的逻辑。

## 🎯 会跳过的状态类型

系统会在两个层面进行状态过滤：

### 1. 数据库查询层过滤
在从 `Post_searchs` 表读取待查询单号时，系统会使用以下SQL查询：

```sql
SELECT search_num, states
FROM Post_searchs
WHERE states NOT IN ('Final delivery', 'Returned to sender')
   OR states IS NULL
```

**会被跳过的状态：**
- ✅ `Final delivery` - 已完成最终配送
- ✅ `Returned to sender` - 已退货给寄件人

**不会被跳过的状态：**
- 🔄 `NULL` - 空状态（新导入的单号）
- 🔄 其他不在上述列表中的状态

### 2. 运行时检查过滤
即使某些单号通过了数据库查询层的过滤，在实际处理每个单号时，系统还会再次检查：

```python
# 跳过已完成的单号
if states in ('Final delivery', 'Returned to sender'):
    print(f"跳过已完成: {tracking_number} (状态: {states})")
    continue
```

这个双重检查确保了系统的健壮性。

## 🔄 状态跳过逻辑流程

```
开始运行爬虫
    ↓
从数据库读取单号（SQL过滤）
    ↓
遍历每个单号
    ↓
├── 检查单号状态
│   ├── 状态在跳过列表中 → 跳过，输出"跳过已完成"
│   └── 状态不在列表中 → 继续处理
    ↓
执行查询逻辑
    ↓
根据查询结果更新状态
```

## 📊 跳过状态的详细说明

### **Final delivery** （最终配送完成）
- **含义**：包裹已成功送达收件人
- **跳过原因**：无需重复查询已完成的配送
- **控制台显示**：`跳过已完成: [单号] (状态: Final delivery)`

### **Returned to sender** （退货给寄件人）
- **含义**：包裹因故退回给寄件人
- **跳过原因**：配送流程已结束，无需继续跟踪
- **控制台显示**：`跳过已完成: [单号] (状态: Returned to sender)`

## 🎯 不会跳过的状态

### **Not registered** （未注册）
- **含义**：单号在日本邮政系统中不存在或未注册
- **处理方式**：系统会继续查询，因为单号可能在后续时间被注册
- **控制台显示**：正常显示查询进度（每次都会尝试查询）

### **NULL/空状态**
- **含义**：新导入的单号，尚未进行首次查询
- **处理方式**：系统会优先处理这些单号
- **控制台显示**：正常显示查询进度

### **其他状态**
- **含义**：不在跳过列表中的任何其他状态（如 "Posting/Collection"、"In transit" 等）
- **处理方式**：系统会正常处理这些单号

## ⚠️ 重要说明：Not registered状态的特殊处理

`Not registered` 状态是系统中一个特殊的例外情况：

- **与其他跳过状态不同**：Final delivery 和 Returned to sender 一旦设置就会被永久跳过
- **Not registered 的逻辑**：虽然查询结果显示"未注册"，但系统不会跳过此类单号
- **业务原因**：单号可能在导入后的一段时间内被日本邮政系统注册，因此需要持续监控
- **实际效果**：每次运行爬虫时，Not registered 状态的单号都会被重新查询

## 📈 性能优化效果

### 跳过机制的优势
1. **提高效率**：避免重复查询已知结果的单号
2. **减少请求**：降低对日本邮政服务器的访问频率
3. **节省时间**：跳过大量已完成单号，加快整体处理速度
4. **降低风险**：减少无效请求，避免被服务器限制

### 统计查询示例
查看各状态的分布情况：

```sql
-- 查看状态分布
SELECT
    states,
    COUNT(*) as count,
    ROUND(COUNT(*) * 100.0 / (SELECT COUNT(*) FROM Post_searchs), 2) as percentage
FROM Post_searchs
GROUP BY states
ORDER BY count DESC;

-- 查看待处理单号数量
SELECT COUNT(*) as pending_count
FROM Post_searchs
WHERE states NOT IN ('Final delivery', 'Returned to sender')
   OR states IS NULL;
```

## ⚙️ 配置和维护

### 修改跳过状态列表
如果需要添加或删除跳过的状态，请在以下位置同时更新：

1. **数据库查询**：`japan_post_crawler.py` 第168行的SQL语句
2. **运行时检查**：`japan_post_crawler.py` 第488行的状态检查
3. **文档更新**：更新本说明文档

### 添加新跳过状态的步骤
```python
# 1. 更新SQL查询中的NOT IN列表
WHERE states NOT IN ('Final delivery', 'Returned to sender', '新跳过状态')

# 2. 更新运行时检查的状态元组
if states in ('Final delivery', 'Returned to sender', '新跳过状态'):
```

## 🔍 调试和监控

### 查看跳过统计
运行爬虫时，系统会在控制台显示跳过的单号：

```
跳过已完成: 628324663886 (状态: Final delivery)
跳过已完成: 628324667504 (状态: Not registered)
正在查询追踪号: 628324668020
```

### 常见问题排查
1. **单号被意外跳过**：检查单号状态是否在跳过列表中
2. **单号未被跳过**：确认状态字段的值是否正确
3. **跳过逻辑不生效**：检查代码中的状态列表是否一致

---

**文档版本**：v1.0
**最后更新**：2024年12月27日
**说明**：详细记录爬虫系统的状态跳过逻辑和实现机制
